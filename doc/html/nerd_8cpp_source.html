<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Network Rerouter Daemon (nerd): nerd.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Network Rerouter Daemon (nerd)
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">nerd.cpp</div>  </div>
</div>
<div class="contents">
<a href="nerd_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (c) Rennie deGraaf, 2007.  All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment">* $Id$</span>
<a name="l00004"></a>00004 <span class="comment">**************************************************/</span>
<a name="l00005"></a>00005 
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;ctime&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;ext/hash_map&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;boost/cstdint.hpp&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;boost/lexical_cast.hpp&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;boost/shared_ptr.hpp&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;netinet/ip.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="Logmsg_8hpp.html">Logmsg.hpp</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="Signals_8hpp.html">Signals.hpp</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="IPQ_8hpp.html">IPQ.hpp</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="WaitList_8hpp.html">WaitList.hpp</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="util_8hpp.html">util.hpp</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="spc__sanitize_8h.html">spc_sanitize.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="drop__priv_8h.html">drop_priv.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="dns_8hpp.html">dns.hpp</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="DnsServerRecord_8hpp.html">DnsServerRecord.hpp</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="libwheel_8h.html">libwheel.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="nerd_8h.html">nerd.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54">00048</a> <span class="preprocessor">#define LOCALHOST_IP 0x7f000001     ///&lt; 127.0.0.1, as an integer in HBO.</span>
<a name="l00049"></a><a class="code" href="nerd_8cpp.html#a5a7162a4cf2bc5e6950e2bf63c1ca47d">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define MAGIC_PORT 1                ///&lt; To servers, client connections will appear to come from this port on localhost.</span>
<a name="l00050"></a><a class="code" href="nerd_8cpp.html#af5fe208f8640c8c789a4d5d5b8ad47f5">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define PIDFILE &quot;/var/run/nerd.pid&quot;  ///&lt; When in daemon mode, write the PID to this file.</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="keyword">namespace </span>NERD
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057 
<a name="l00102"></a>00102 <span class="keyword">class </span>ConnectionServer
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104   <span class="keyword">public</span>:
<a name="l00105"></a>00105     <a class="code" href="classNERD_1_1ConnectionServer.html#acc6df09182bd47a744638d2784a7f3df" title="Constructor for ConnectionServer.">ConnectionServer</a>(<span class="keyword">const</span> std::string&amp; root, <span class="keywordtype">bool</span> verb, <span class="keywordtype">bool</span> restrict) <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classIPQ_1_1IpqException.html" title="Base class for exceptions thrown by IPQ methods.">IPQ::IpqException</a>, <a class="code" href="classLibWheel_1_1IOException.html" title="Exception thrown when an I/O error occurs.">LibWheel::IOException</a>, <a class="code" href="classLibWheel_1_1SocketException.html" title="Exception thrown when a socket error occurs.">LibWheel::SocketException</a>));
<a name="l00106"></a>00106     <a class="code" href="classNERD_1_1ConnectionServer.html#abd4458dd96ff0b366de34ecf24855ec4" title="Destructor for ConnectionServer.">~ConnectionServer</a>();
<a name="l00107"></a>00107     <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer.html#af506b23a0c81f40f8f449bb388005424" title="Main loop for ConnectionServer.">operator()</a>();
<a name="l00108"></a>00108     <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer.html#a52574c2792a324c56435234da19cc183" title="Print current server status to LibWheel::logmsg.">printStats</a>() <span class="keyword">const</span>;
<a name="l00109"></a>00109   <span class="keyword">private</span>:
<a name="l00114"></a>00114     <span class="keyword">class </span>UnknownConnectionException : <span class="keyword">public</span> std::runtime_error
<a name="l00115"></a>00115     {
<a name="l00116"></a>00116       <span class="keyword">public</span>:
<a name="l00117"></a>00117         <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html#aa102c5354baed9c1abde486991bd8616" title="Constructor for UnknownConnectionException.">UnknownConnectionException</a>(<span class="keyword">const</span> std::string&amp; s);
<a name="l00118"></a>00118     };
<a name="l00119"></a>00119 
<a name="l00124"></a>00124     <span class="keyword">class </span>UnknownServerException : <span class="keyword">public</span> std::runtime_error
<a name="l00125"></a>00125     {
<a name="l00126"></a>00126       <span class="keyword">public</span>:
<a name="l00127"></a>00127         <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownServerException.html#a776dc360b65b101756bdf5ed9ccf4f95" title="Constructor for UnknownServerException.">UnknownServerException</a>(<span class="keyword">const</span> std::string&amp; s);
<a name="l00128"></a>00128     };
<a name="l00129"></a>00129     
<a name="l00134"></a>00134     <span class="keyword">struct </span>AddressPair
<a name="l00135"></a>00135     {
<a name="l00136"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a96cf9e68f77b3c0894cc70be7440c230">00136</a>         <span class="keyword">const</span> boost::uint32_t <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a96cf9e68f77b3c0894cc70be7440c230" title="Packet source IP address.">srcAddr</a>; 
<a name="l00137"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a820ebb84f573dc37a49261ab707d435f">00137</a>         <span class="keyword">const</span> boost::uint32_t <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a820ebb84f573dc37a49261ab707d435f" title="Packet destination IP address.">dstAddr</a>; 
<a name="l00138"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#ae4d253c1b72fe3424484d5d02a38c073">00138</a>         <span class="keyword">const</span> boost::uint16_t <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#ae4d253c1b72fe3424484d5d02a38c073" title="Packet source port.">srcPort</a>; 
<a name="l00139"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#ad2962570ad683405d91087e11f78aeea">00139</a>         <span class="keyword">const</span> boost::uint16_t <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#ad2962570ad683405d91087e11f78aeea" title="Packet destination port.">dstPort</a>; 
<a name="l00140"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a298c525bf23bb1ccec0d7d1b2b4ee2db">00140</a>         <span class="keyword">const</span> boost::uint8_t <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a298c525bf23bb1ccec0d7d1b2b4ee2db" title="Packet transport protocol number.">protocol</a>; 
<a name="l00141"></a>00141         <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a754684b80d70b7ec666a23cfcfce1362" title="Constructor for AddressPair.">AddressPair</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt);
<a name="l00142"></a>00142         <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a754684b80d70b7ec666a23cfcfce1362" title="Constructor for AddressPair.">AddressPair</a>(boost::uint32_t sa, boost::uint32_t da, boost::uint16_t sp, boost::uint16_t dp, boost::uint8_t prot);
<a name="l00143"></a>00143         <span class="keywordtype">bool</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a39646b4ae1a85e00388f8282b50945b7" title="Comparison operator for AddressPair.">operator==</a>(<span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; a) <span class="keyword">const</span>;
<a name="l00144"></a>00144     };
<a name="l00145"></a>00145     
<a name="l00150"></a>00150     <span class="keyword">class </span><a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html" title="A functor that computes a hash of an AddressPair, suitable for use with __gnu_cxx::hash_map.">AddressPairHash</a>
<a name="l00151"></a>00151     {
<a name="l00152"></a>00152       <span class="keyword">public</span>:
<a name="l00153"></a>00153         <span class="keywordtype">size_t</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#a36bbb841fe3f2cbacb4cab2687675c4d" title="Compute a hash of an AddressPair.">operator()</a>(<span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; addr) <span class="keyword">const</span>;
<a name="l00154"></a>00154       <span class="keyword">private</span>:
<a name="l00155"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#aa97511d9c6987cd101fb7f201f8e660a">00155</a>         __gnu_cxx::hash&lt;boost::uint32_t&gt; <a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#aa97511d9c6987cd101fb7f201f8e660a" title="A hasher for unsigned 32-bit integers.">hash32</a>; 
<a name="l00156"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#aada49946f39b27b07f36934b5e1d5ac6">00156</a>         __gnu_cxx::hash&lt;boost::uint16_t&gt; <a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#aada49946f39b27b07f36934b5e1d5ac6" title="A hasher for unsigned 16-bit integers.">hash16</a>; 
<a name="l00157"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#aa5cd9f0aee285e5abf215216e031391a">00157</a>         __gnu_cxx::hash&lt;boost::uint8_t&gt; <a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#aa5cd9f0aee285e5abf215216e031391a" title="A hasher for unsigned 8-bit integers.">hash8</a>;   
<a name="l00158"></a>00158     };
<a name="l00159"></a>00159     
<a name="l00163"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee">00163</a>     <span class="keyword">typedef</span> __gnu_cxx::hash_map&lt;AddressPair, AddressPair, AddressPairHash&gt; <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     
<a name="l00169"></a>00169     <span class="keyword">class </span><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html" title="A description of a connection managed by a server program.">Connection</a>
<a name="l00170"></a>00170     {
<a name="l00171"></a>00171       <span class="keyword">public</span>:
<a name="l00172"></a>00172         <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a84d83200cead40def8a0eb1c4480f6e2" title="Constructor for Connection.">Connection</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt, boost::uint32_t rsaddr, boost::uint32_t rdaddr, boost::uint16_t rsport, boost::uint16_t rdport, <span class="keyword">const</span> std::string&amp; name);
<a name="l00173"></a>00173         <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#af076490d2f7f9b23ed91ba3ff6452f9d" title="Retrieve the addresses of packets sent from a client to a server for a Connection.">getForwardAddr</a>() <span class="keyword">const</span>;
<a name="l00174"></a>00174         <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a4998c37ce0f55a17904ded653e5ea95b" title="Retrieve the addresses of packets sent from a server to a client for a Connection.">getReverseAddr</a>() <span class="keyword">const</span>;
<a name="l00175"></a>00175         <span class="keyword">const</span> std::string&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a1554fbce9d1ff09e21507fb372fd7077" title="Retrieve the name of the server program handling a connection.">getName</a>() <span class="keyword">const</span>;
<a name="l00176"></a>00176       <span class="keyword">private</span>:
<a name="l00177"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a1e0a150fe344d8ac0173ff34985f275f">00177</a>         <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a1e0a150fe344d8ac0173ff34985f275f" title="The addresses of packets sent by a client to a server.">forwardAddr</a>; 
<a name="l00178"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#add4fb710d6212e0f8501bb2bb29b523d">00178</a>         <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#add4fb710d6212e0f8501bb2bb29b523d" title="The addresses of packets sent by a server to a client.">reverseAddr</a>; 
<a name="l00179"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#ac2d5abf39fc698fd831419e20bbc0eba">00179</a>         <span class="keyword">const</span> std::string <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#ac2d5abf39fc698fd831419e20bbc0eba" title="The name of the server program handling a connection.">serverName</a>;  
<a name="l00180"></a>00180     };
<a name="l00181"></a>00181     
<a name="l00186"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d">00186</a>     <span class="keyword">typedef</span> __gnu_cxx::hash_map&lt;pid_t, Connection&gt; <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>;
<a name="l00187"></a>00187     
<a name="l00192"></a>00192     <span class="keyword">struct </span><a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html" title="Information pertaining to a server that is starting up to handle a connection.">PendingConnection</a>
<a name="l00193"></a>00193     {
<a name="l00194"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#ad536775b738bdf1f819d7ad416214b71">00194</a>         boost::shared_ptr&lt;IPQ::IpqTcpPacket&gt; <a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#ad536775b738bdf1f819d7ad416214b71" title="The packet that is initiating the connection to be handled by this server; to be redirected to the se...">packet</a>; 
<a name="l00195"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#a227bb11370e616eab7eb9a67b4cdf4ca">00195</a>         <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#a227bb11370e616eab7eb9a67b4cdf4ca" title="The read end of a pipe from which to read the port number that the server is using; the write end is ...">pipefd</a>; 
<a name="l00196"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#aa6bf63096cc00bffa641e31867cec98d">00196</a>         <span class="keyword">const</span> std::string <a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#aa6bf63096cc00bffa641e31867cec98d" title="The name of the server program.">serverName</a>; 
<a name="l00197"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#a7a98b508720b6c7bc1f2028c3b2696d5">00197</a>         <span class="keyword">const</span> pid_t <a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#a7a98b508720b6c7bc1f2028c3b2696d5" title="The process ID of the server program.">pid</a>; 
<a name="l00198"></a>00198         <a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#a1380579c5d0abbc5faaf130e7f9ad1eb" title="Constructor for PendingConnection.">PendingConnection</a>(<a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt, <span class="keywordtype">int</span> fd, <span class="keyword">const</span> std::string&amp; name, pid_t p);
<a name="l00199"></a>00199     };
<a name="l00200"></a>00200     
<a name="l00201"></a>00201   <span class="keyword">public</span>:
<a name="l00207"></a><a class="code" href="classNERD_1_1ConnectionServer.html#ac838d247f33cef856ae722343a8cb7ff">00207</a>     <span class="keyword">typedef</span> LibWheel::WaitList&lt;PendingConnection&gt; <a class="code" href="classNERD_1_1ConnectionServer.html#ac838d247f33cef856ae722343a8cb7ff" title="A list of pending connections.">PendingConnectionList</a>;
<a name="l00208"></a>00208 
<a name="l00215"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a63d211040487b4566f2f696026723932">00215</a>     <span class="keyword">typedef</span> LibWheel::WaitList&lt;std::pair&lt;RedirectionTable*, RedirectionTable::iterator&gt; &gt; <a class="code" href="classNERD_1_1ConnectionServer.html#a63d211040487b4566f2f696026723932" title="A list of redirection rules that are scheduled to be deleted at their expiry of timers.">TimeoutList</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217   <span class="keyword">private</span>:  
<a name="l00221"></a>00221     <span class="keyword">struct </span><a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html" title="Information about a server program to be started.">ServerRecord</a>
<a name="l00222"></a>00222     {
<a name="l00223"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a741796c62f55fc2d3b7ac5807d4bfdf8">00223</a>         <span class="keyword">const</span> std::string <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a741796c62f55fc2d3b7ac5807d4bfdf8" title="The IP address to be emulated by a server program, as a string.">serverAddr</a>; 
<a name="l00224"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a8eeda51ef462eeabb3d66b130fe70e56">00224</a>         <span class="keyword">const</span> std::string <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a8eeda51ef462eeabb3d66b130fe70e56" title="The port number to be emulated by a server program, as a string.">serverPort</a>; 
<a name="l00225"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a8e253a76e9dbd9eaf239f09ff9d1e69f">00225</a>         <span class="keyword">const</span> std::string <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a8e253a76e9dbd9eaf239f09ff9d1e69f" title="The transport protocol of serverPort.">serverProto</a>; 
<a name="l00226"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c">00226</a>         std::string <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>; 
<a name="l00227"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a1272b0f4ca611ecc8c2b2b76c75c5f91">00227</a>         std::string <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a1272b0f4ca611ecc8c2b2b76c75c5f91" title="The DNS TXT record for serverAddr.">serverDnsRecord</a>; 
<a name="l00228"></a>00228         <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a787396107afcb77da909db0fab301d9e" title="Constructor for ServerRecord.">ServerRecord</a>(<span class="keyword">const</span> std::string&amp; addr, <span class="keyword">const</span> std::string&amp; port, <span class="keyword">const</span> std::string&amp; proto);
<a name="l00229"></a>00229     };
<a name="l00230"></a>00230     
<a name="l00236"></a>00236     <span class="keyword">class </span><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html" title="Functor to handle SIGCHLD signals received through LibWheel::SignalQueue.">ServerExitHandler</a>
<a name="l00237"></a>00237     {
<a name="l00238"></a>00238       <span class="keyword">public</span>:
<a name="l00239"></a>00239         <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a0a3634beb4eac3315afb6671205c399a" title="Constructor for ServerExitHandler.">ServerExitHandler</a>(<a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>&amp; pcl, <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>&amp; rt, <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>&amp; st, <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">TimeoutList</a>&amp; tl, <span class="keywordtype">bool</span> v);
<a name="l00240"></a>00240         <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a9ca943b524de0b1f1907cecaab2943e1" title="Call operator for ServerExitHandler.">operator()</a>();
<a name="l00241"></a>00241       <span class="keyword">private</span>:
<a name="l00242"></a>00242         <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>::iterator <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#ac380cd94aeac14ce16c7d957d999941c" title="Look up a pending connection given the PID of its server.">findPendingConnection</a>(pid_t pid);
<a name="l00243"></a>00243         
<a name="l00244"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a0953476221ba91597772e457b7357eae">00244</a>         <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a0953476221ba91597772e457b7357eae" title="A reference to the containing ConnectionServer&#39;s list of pending connections.">pendingConnections</a>; 
<a name="l00245"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#af4572dea480ca71da58a92ce88b8153e">00245</a>         <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#af4572dea480ca71da58a92ce88b8153e" title="A reference to the containing ConnectionServer&#39;s table of redirection rules.">redirections</a>; 
<a name="l00246"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a9155fa7acc10d3e954d5998624c80bd7">00246</a>         <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a9155fa7acc10d3e954d5998624c80bd7" title="A reference to the containing ConnectionServer&#39;s look-up table of active servers.">servers</a>; 
<a name="l00247"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#ac95b8019ae4312f278e28808e92b77a1">00247</a>         <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">TimeoutList</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#ac95b8019ae4312f278e28808e92b77a1" title="A reference to the containing ConnectionServer&#39;s list of redirection rules awaiting removal...">timeoutList</a>; 
<a name="l00248"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#ac25e75d9b69963b6c0624099b8d6ec15">00248</a>         <span class="keywordtype">bool</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#ac25e75d9b69963b6c0624099b8d6ec15" title="true to log extra messages; false otherwise.">verbose</a>; 
<a name="l00249"></a>00249     };
<a name="l00250"></a>00250     
<a name="l00257"></a>00257     <span class="keyword">class </span><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html" title="Functor to handle SIGIO signals received through LibWheel::SignalQueue.">ServerWritebackHandler</a>
<a name="l00258"></a>00258     {
<a name="l00259"></a>00259       <span class="keyword">public</span>:
<a name="l00260"></a>00260         <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#ab92b47891071f80818d7bde25cae902c" title="Constructor for ServerWritebackHandler.">ServerWritebackHandler</a>(<a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>&amp; pcl, <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>&amp; rt, <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>&amp; st, <a class="code" href="classIPQ_1_1IpqSocket.html" title="A program&#39;s link to libipq.">IPQ::IpqSocket</a>&amp; s);
<a name="l00261"></a>00261         <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#addc9ae778c4e9375c4499dab4eef2074" title="Call operator for ServerWritebackHandler.">operator()</a>();
<a name="l00262"></a>00262       <span class="keyword">private</span>:
<a name="l00263"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#ab13916995c4c8ed9debb0ebac0cca091">00263</a>         <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#ab13916995c4c8ed9debb0ebac0cca091" title="A reference to the containing ConnectionServer&#39;s list of pending connections.">pendingConnections</a>; 
<a name="l00264"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#a436b00e74f3cab280212aea4c4068838">00264</a>         <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#a436b00e74f3cab280212aea4c4068838" title="A reference to the containing ConnectionServer&#39;s table of redirection rules.">redirections</a>; 
<a name="l00265"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#aa08d6aaad29ae5ece57c9f0623803e06">00265</a>         <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#aa08d6aaad29ae5ece57c9f0623803e06" title="A reference to the containing ConnectionServer&#39;s look-up table of active servers.">servers</a>; 
<a name="l00266"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#a452352f53ba0bf33d1a4be562bd1f490">00266</a>         IPQ::IpqSocket&amp; <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#a452352f53ba0bf33d1a4be562bd1f490" title="A handle to libipq.">sock</a>; 
<a name="l00267"></a>00267     };
<a name="l00268"></a>00268     
<a name="l00269"></a>00269     <span class="comment">// private methods</span>
<a name="l00270"></a>00270     <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer.html#a5b183a39539b07fe4a92ef3ad88d7c92" title="Handle a packet.">handlePacket</a>(<a class="code" href="classIPQ_1_1IpqPacket.html" title="Base class for packets received via IpqSocket.">IPQ::IpqPacket</a>* pkt);
<a name="l00271"></a>00271     <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer.html#afd85b7ad69696355650a0177d01f0a06" title="Looks up a redirection rule for a TCP packet.">getRedirectRule</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt) <span class="keyword">const</span> <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html" title="Exception thrown by getRedirectRule() when a packet does not match any existing connection record...">UnknownConnectionException</a>));
<a name="l00272"></a>00272     <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; <a class="code" href="classNERD_1_1ConnectionServer.html#afd85b7ad69696355650a0177d01f0a06" title="Looks up a redirection rule for a TCP packet.">getRedirectRule</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqUdpPacket.html" title="An complete IPv4/UDP packet that was received via IpqSocket.">IPQ::IpqUdpPacket</a>* pkt) <span class="keyword">const</span> <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html" title="Exception thrown by getRedirectRule() when a packet does not match any existing connection record...">UnknownConnectionException</a>));
<a name="l00273"></a>00273     <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer.html#af4ba681fed213914c83661a1dfd8df6d" title="Creates a TCP connection.">createConnection</a>(<a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt);
<a name="l00274"></a>00274     <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer.html#af4ba681fed213914c83661a1dfd8df6d" title="Creates a TCP connection.">createConnection</a>(<a class="code" href="classIPQ_1_1IpqUdpPacket.html" title="An complete IPv4/UDP packet that was received via IpqSocket.">IPQ::IpqUdpPacket</a>* pkt);
<a name="l00275"></a>00275     <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1ConnectionServer.html#a9d75b0d048d374095c4d7c96e4add7f8" title="Attempts to find a server program to run in response to a connection request.">findServer</a>(<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html" title="Information about a server program to be started.">ServerRecord</a>&amp; rec, in_addr_t addr) <span class="keyword">const</span> <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownServerException.html" title="Exception thrown by findServer() when no server program can be found to handle a new connection...">UnknownServerException</a>));
<a name="l00276"></a>00276     <span class="keywordtype">bool</span> <a class="code" href="classNERD_1_1ConnectionServer.html#a31818d0fbe0366a7b902095445405406" title="Determines if a file is executable.">isExecutable</a>(<span class="keyword">const</span> std::string&amp; file) <span class="keyword">const</span>;
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     <span class="comment">// private member variables</span>
<a name="l00279"></a><a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0">00279</a>     IPQ::IpqSocket&amp; <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>;                    
<a name="l00280"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a5e476e6dd3a15d073b4a3f75569dc240">00280</a>     <span class="keyword">const</span> std::string <a class="code" href="classNERD_1_1ConnectionServer.html#a5e476e6dd3a15d073b4a3f75569dc240" title="The directory in which to search for server programs.">serverRoot</a>;            
<a name="l00281"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403">00281</a>     <span class="keywordtype">bool</span> <a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403" title="true to log extra messages; false otherwise">verbose</a>;                            
<a name="l00282"></a><a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c">00282</a>     <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a> <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>;
<a name="l00283"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075">00283</a>     <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>;           
<a name="l00284"></a><a class="code" href="classNERD_1_1ConnectionServer.html#adc22ef94ff5d014433eef07e054e1d69">00284</a>     <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">TimeoutList</a> <a class="code" href="classNERD_1_1ConnectionServer.html#adc22ef94ff5d014433eef07e054e1d69" title="A list of redirection rules to be deleted when timeouts expire.">timeoutList</a>;                 
<a name="l00285"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67">00285</a>     <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>;                     
<a name="l00286"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a87fc9625f6d518ffe294e4f759d3cae0">00286</a>     <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html" title="Functor to handle SIGCHLD signals received through LibWheel::SignalQueue.">ServerExitHandler</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a87fc9625f6d518ffe294e4f759d3cae0" title="The functor that handles SIGCHLD signals when servers exit.">exitHandler</a>;           
<a name="l00287"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a8aa938754f8f34144d205d4dd208d91a">00287</a>     <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html" title="Functor to handle SIGIO signals received through LibWheel::SignalQueue.">ServerWritebackHandler</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a8aa938754f8f34144d205d4dd208d91a" title="The functor that handles SIGIO signals when servers write back their port numbers.">writebackHandler</a>; 
<a name="l00288"></a><a class="code" href="classNERD_1_1ConnectionServer.html#ae54611cb80881c2a73d69e145df4bbd7">00288</a>     <span class="keywordtype">bool</span> <a class="code" href="classNERD_1_1ConnectionServer.html#ae54611cb80881c2a73d69e145df4bbd7" title="true to limit the privileges of server programs; false otherwise.">restrict_servers</a>;                   
<a name="l00289"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a3168fab5ca817d2cd2cb7ca15228440d">00289</a>     <span class="keywordtype">int</span> <a class="code" href="classNERD_1_1ConnectionServer.html#a3168fab5ca817d2cd2cb7ca15228440d" title="A socket bound to 127.0.0.1:MAGIC_PORT/TCP.">magic_sock</a>;                          
<a name="l00290"></a>00290 };
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 
<a name="l00296"></a>00296 <span class="keyword">class </span><a class="code" href="classNERD_1_1StatPrinter.html" title="Functor to print current server statistics.">StatPrinter</a>
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298   <span class="keyword">public</span>:
<a name="l00299"></a>00299     <a class="code" href="classNERD_1_1StatPrinter.html#a9e15d664037ee9b034a20e4a2c758e37" title="Initialize a StatPrinter.">StatPrinter</a>(<span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a>&amp; cs);
<a name="l00300"></a>00300     <span class="keywordtype">void</span> <a class="code" href="classNERD_1_1StatPrinter.html#a276b7e4358a2cd8ec5a3972f86452d2c" title="Print the current statistics for a ConnectionServer.">operator()</a>() <span class="keyword">const</span>;
<a name="l00301"></a>00301   <span class="keyword">private</span>:
<a name="l00302"></a><a class="code" href="classNERD_1_1StatPrinter.html#a6040df27f017b5ce2ac0ed1d9f68d50b">00302</a>     <span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a>&amp; <a class="code" href="classNERD_1_1StatPrinter.html#a6040df27f017b5ce2ac0ed1d9f68d50b" title="A reference to a server object whose statistica are to be printed.">connectionServer</a>; 
<a name="l00303"></a>00303 };
<a name="l00304"></a>00304     
<a name="l00305"></a>00305 } <span class="comment">// namespace NERD</span>
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">/* Specializations of WaitList.  C++ requires that template specializations be </span>
<a name="l00309"></a>00309 <span class="comment">   in the same namespace as the template. */</span>
<a name="l00310"></a>00310 <span class="keyword">namespace </span>LibWheel
<a name="l00311"></a>00311 {
<a name="l00312"></a>00312 
<a name="l00318"></a>00318 <span class="keyword">template</span> &lt;&gt;
<a name="l00319"></a>00319 NERD::ConnectionServer::PendingConnectionList::iterator
<a name="l00320"></a>00320 <a class="code" href="classLibWheel_1_1WaitList.html#a975195ad3a9b2c38453291a1633cf78b" title="Removes an object from the list.">NERD::ConnectionServer::PendingConnectionList::erase</a>(iterator&amp; i)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322     <span class="keywordtype">int</span> retval;
<a name="l00323"></a>00323     retval = <a class="code" href="namespaceLibWheel.html#a6941e854dd6b671e040bcffd561c22e5" title="Close a file descriptor.">uninterruptible_close</a>(i-&gt;value.pipefd);
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (retval == -1)
<a name="l00325"></a>00325     {
<a name="l00326"></a>00326         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error closing pipe: %s&quot;</span>, std::strerror(errno));
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328     <span class="keywordflow">return</span> objs.erase(i);
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00336"></a>00336 <span class="keyword">template</span> &lt;&gt;
<a name="l00337"></a>00337 <span class="keywordtype">void</span>
<a name="l00338"></a>00338 <a class="code" href="classLibWheel_1_1WaitList_1_1WaitGC.html#afb5c536ce88b8c365753e2e491135f55" title="Call operator for WaitList::WaitGC.">NERD::ConnectionServer::PendingConnectionList::WaitGC::operator()</a>()
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <span class="keywordtype">int</span> retval;
<a name="l00341"></a>00341     
<a name="l00342"></a>00342     <span class="comment">// remove all servers that haven&#39;t sent us a port number within &lt;timeout&gt; seconds</span>
<a name="l00343"></a>00343     <span class="keywordflow">while</span> ((objs.begin() != objs.end()) &amp;&amp; (difftime(time(NULL), objs.begin()-&gt;timeout)&gt;=0))
<a name="l00344"></a>00344     {
<a name="l00345"></a>00345         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;Server %s (pid %d) not responding; dropping connection&quot;</span>, objs.begin()-&gt;value.serverName.c_str(), objs.begin()-&gt;value.pid);
<a name="l00346"></a>00346         
<a name="l00347"></a>00347         <span class="comment">// close the pipe</span>
<a name="l00348"></a>00348         retval = <a class="code" href="namespaceLibWheel.html#a6941e854dd6b671e040bcffd561c22e5" title="Close a file descriptor.">uninterruptible_close</a>(objs.begin()-&gt;value.pipefd);
<a name="l00349"></a>00349         <span class="keywordflow">if</span> (retval == -1)
<a name="l00350"></a>00350         {
<a name="l00351"></a>00351             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error closing pipe: %s&quot;</span>, std::strerror(errno));
<a name="l00352"></a>00352         }
<a name="l00353"></a>00353         
<a name="l00354"></a>00354         <span class="comment">// try to kill the process</span>
<a name="l00355"></a>00355         <span class="keywordflow">if</span> (objs.begin()-&gt;value.pid &gt; 0)
<a name="l00356"></a>00356             (<span class="keywordtype">void</span>)kill(objs.begin()-&gt;value.pid, SIGINT);
<a name="l00357"></a>00357         
<a name="l00358"></a>00358         objs.pop_front();
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 
<a name="l00368"></a>00368 <span class="keyword">template</span> &lt;&gt;
<a name="l00369"></a>00369 NERD::ConnectionServer::TimeoutList::iterator
<a name="l00370"></a>00370 <a class="code" href="classLibWheel_1_1WaitList.html#a975195ad3a9b2c38453291a1633cf78b" title="Removes an object from the list.">NERD::ConnectionServer::TimeoutList::erase</a>(iterator&amp; i)
<a name="l00371"></a>00371 {
<a name="l00372"></a>00372     i-&gt;value.first-&gt;erase(i-&gt;value.second);
<a name="l00373"></a>00373     <span class="keywordflow">return</span> objs.erase(i);
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00382"></a>00382 <span class="keyword">template</span> &lt;&gt;
<a name="l00383"></a>00383 <span class="keywordtype">void</span>
<a name="l00384"></a>00384 <a class="code" href="classLibWheel_1_1WaitList_1_1WaitGC.html#afb5c536ce88b8c365753e2e491135f55" title="Call operator for WaitList::WaitGC.">NERD::ConnectionServer::TimeoutList::WaitGC::operator()</a>()
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386     <span class="comment">// remove all connections that have timed out</span>
<a name="l00387"></a>00387     <span class="keywordflow">while</span> ((objs.begin() != objs.end()) &amp;&amp; (difftime(time(NULL), objs.begin()-&gt;timeout)&gt;=0))
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389         <span class="comment">//LibWheel::logmsg(LibWheel::logmsg_info, &quot;Deleting connection&quot;);</span>
<a name="l00390"></a>00390         objs.begin()-&gt;value.first-&gt;erase(objs.begin()-&gt;value.second);
<a name="l00391"></a>00391         
<a name="l00392"></a>00392         objs.pop_front();
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396 } <span class="comment">// namespace LibWheel</span>
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 <span class="keyword">namespace </span>NERD
<a name="l00400"></a>00400 {
<a name="l00401"></a>00401 
<a name="l00413"></a><a class="code" href="classNERD_1_1ConnectionServer.html#acc6df09182bd47a744638d2784a7f3df">00413</a> <a class="code" href="classNERD_1_1ConnectionServer.html#acc6df09182bd47a744638d2784a7f3df" title="Constructor for ConnectionServer.">ConnectionServer::ConnectionServer</a>(<span class="keyword">const</span> std::string&amp; root, <span class="keywordtype">bool</span> verb, <span class="keywordtype">bool</span> restrict) <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classIPQ_1_1IpqException.html" title="Base class for exceptions thrown by IPQ methods.">IPQ::IpqException</a>, <a class="code" href="classLibWheel_1_1IOException.html" title="Exception thrown when an I/O error occurs.">LibWheel::IOException</a>, <a class="code" href="classLibWheel_1_1SocketException.html" title="Exception thrown when a socket error occurs.">LibWheel::SocketException</a>))
<a name="l00414"></a>00414 : sock(IPQ::IpqSocket::getSocket()), serverRoot(root), verbose(verb), pendingConnections(<a class="code" href="nerd_8h.html#ae2efab2aa91eb500d5596c85b992655c" title="If NERD has not received a port number from a server within this many seconds of it starting...">NERD_SERVER_TIMEOUT</a>), redirections(), timeoutList(<a class="code" href="nerd_8h.html#a830234a09246e7f1e8932be42df60eed" title="After a server exits, packets will still be forwarded to it for this many seconds.">NERD_CONNECTION_TIMEOUT</a>), exitHandler(pendingConnections, redirections, servers, timeoutList, verbose), writebackHandler(pendingConnections, redirections, servers, sock), restrict_servers(restrict), magic_sock()
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416     <span class="keywordtype">int</span> retval;
<a name="l00417"></a>00417     <span class="keyword">struct </span>stat statbuf;
<a name="l00418"></a>00418     <span class="keyword">struct </span>sockaddr_in magic_addr;
<a name="l00419"></a>00419     
<a name="l00420"></a>00420     <span class="comment">// initialize IPQ</span>
<a name="l00421"></a>00421     sock.connect();
<a name="l00422"></a>00422     sock.setCopyMode(<a class="code" href="classIPQ_1_1IpqSocket.html#afee6d75480079906ecf6544f8467e0ccafc1e90369658a807b2c970d3e15b01d4" title="Copy both packet metadata and contents.">IPQ::IpqSocket::PACKET</a>, 65535);
<a name="l00423"></a>00423     
<a name="l00424"></a>00424     <span class="comment">// ensure that serverRoot is a readable directory</span>
<a name="l00425"></a>00425     retval = ::stat(serverRoot.c_str(), &amp;statbuf);
<a name="l00426"></a>00426     <span class="keywordflow">if</span> (retval == -1)
<a name="l00427"></a>00427     {
<a name="l00428"></a>00428         <span class="keywordflow">throw</span> <a class="code" href="classLibWheel_1_1IOException.html" title="Exception thrown when an I/O error occurs.">LibWheel::IOException</a>(std::string(<span class="stringliteral">&quot;Error accessing &quot;</span>) + serverRoot + <span class="stringliteral">&quot;: &quot;</span> + std::strerror(errno));
<a name="l00429"></a>00429     }
<a name="l00430"></a>00430     <span class="keywordflow">if</span> (!S_ISDIR(statbuf.st_mode))
<a name="l00431"></a>00431     {
<a name="l00432"></a>00432         <span class="keywordflow">throw</span> <a class="code" href="classLibWheel_1_1IOException.html" title="Exception thrown when an I/O error occurs.">LibWheel::IOException</a>(std::string(<span class="stringliteral">&quot;Error: &quot;</span>) + serverRoot + <span class="stringliteral">&quot; is not a directory&quot;</span>);
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     
<a name="l00435"></a>00435     <span class="comment">// bind to the magic port, to make sure that nothing else is using it</span>
<a name="l00436"></a>00436     magic_sock = socket(PF_INET, SOCK_STREAM, 0);
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (magic_sock == -1)
<a name="l00438"></a>00438     {
<a name="l00439"></a>00439         <span class="keywordflow">throw</span> <a class="code" href="classLibWheel_1_1SocketException.html" title="Exception thrown when a socket error occurs.">LibWheel::SocketException</a>(std::string(<span class="stringliteral">&quot;Error binding to 127.0.0.1:&quot;</span> <a class="code" href="libwheel_8h.html#a2117b58e19182dff91ad3558e650541d" title="Quote a macro argument.">QUOTE</a>(<a class="code" href="nerd_8cpp.html#a5a7162a4cf2bc5e6950e2bf63c1ca47d" title="To servers, client connections will appear to come from this port on localhost.">MAGIC_PORT</a>)) + <span class="stringliteral">&quot;/TCP: &quot;</span> + std::strerror(errno));
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     std::memset(&amp;magic_addr, 0, <span class="keyword">sizeof</span>(magic_addr));
<a name="l00442"></a>00442     magic_addr.sin_family = AF_INET;
<a name="l00443"></a>00443     magic_addr.sin_addr.s_addr = htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>);
<a name="l00444"></a>00444     magic_addr.sin_port = htons(<a class="code" href="nerd_8cpp.html#a5a7162a4cf2bc5e6950e2bf63c1ca47d" title="To servers, client connections will appear to come from this port on localhost.">MAGIC_PORT</a>);
<a name="l00445"></a>00445     retval = bind(magic_sock, reinterpret_cast&lt;struct sockaddr*&gt;(&amp;magic_addr), <span class="keyword">sizeof</span>(magic_addr));
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (retval == -1)
<a name="l00447"></a>00447     {
<a name="l00448"></a>00448         <span class="keywordflow">throw</span> <a class="code" href="classLibWheel_1_1SocketException.html" title="Exception thrown when a socket error occurs.">LibWheel::SocketException</a>(std::string(<span class="stringliteral">&quot;Error binding to 127.0.0.1:&quot;</span> <a class="code" href="libwheel_8h.html#a2117b58e19182dff91ad3558e650541d" title="Quote a macro argument.">QUOTE</a>(<a class="code" href="nerd_8cpp.html#a5a7162a4cf2bc5e6950e2bf63c1ca47d" title="To servers, client connections will appear to come from this port on localhost.">MAGIC_PORT</a>)) + <span class="stringliteral">&quot;/TCP: &quot;</span> + std::strerror(errno));
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450     
<a name="l00451"></a>00451     <span class="comment">// set signal handlers</span>
<a name="l00452"></a>00452     <a class="code" href="classLibWheel_1_1SignalQueue.html#ac0145e9276c339fccebe3c0b70cec914" title="Set the action to perform when a signal is received.">LibWheel::SignalQueue::setHandler</a>(SIGCHLD, <a class="code" href="classLibWheel_1_1SignalQueue.html#a5a366bd8de3564c5e3001233464d20e3a4ee98693cfe0961ea7dcfac5f2053174" title="Call all registered signal handlers when a signal is received.">LibWheel::SignalQueue::HANDLE</a>);
<a name="l00453"></a>00453     <a class="code" href="classLibWheel_1_1SignalQueue.html#ada6b998cee9ced93ac7e046199187fa6" title="Add a handler function for a signal.">LibWheel::SignalQueue::addHandler</a>(SIGCHLD, boost::ref(exitHandler));
<a name="l00454"></a>00454     <a class="code" href="classLibWheel_1_1SignalQueue.html#ac0145e9276c339fccebe3c0b70cec914" title="Set the action to perform when a signal is received.">LibWheel::SignalQueue::setHandler</a>(SIGIO, <a class="code" href="classLibWheel_1_1SignalQueue.html#a5a366bd8de3564c5e3001233464d20e3a4ee98693cfe0961ea7dcfac5f2053174" title="Call all registered signal handlers when a signal is received.">LibWheel::SignalQueue::HANDLE</a>);
<a name="l00455"></a>00455     <a class="code" href="classLibWheel_1_1SignalQueue.html#ada6b998cee9ced93ac7e046199187fa6" title="Add a handler function for a signal.">LibWheel::SignalQueue::addHandler</a>(SIGIO, boost::ref(writebackHandler));
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 
<a name="l00463"></a><a class="code" href="classNERD_1_1ConnectionServer.html#abd4458dd96ff0b366de34ecf24855ec4">00463</a> <a class="code" href="classNERD_1_1ConnectionServer.html#abd4458dd96ff0b366de34ecf24855ec4" title="Destructor for ConnectionServer.">ConnectionServer::~ConnectionServer</a>()
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465     <span class="comment">// clear signal handlers</span>
<a name="l00466"></a>00466     <a class="code" href="classLibWheel_1_1SignalQueue.html#a16b57819e9a601533b9bff97ec08b5e5" title="Unregister a handler for a signal.">LibWheel::SignalQueue::deleteHandler</a>(SIGIO, boost::ref(<a class="code" href="classNERD_1_1ConnectionServer.html#a8aa938754f8f34144d205d4dd208d91a" title="The functor that handles SIGIO signals when servers write back their port numbers.">writebackHandler</a>));
<a name="l00467"></a>00467     <a class="code" href="classLibWheel_1_1SignalQueue.html#a16b57819e9a601533b9bff97ec08b5e5" title="Unregister a handler for a signal.">LibWheel::SignalQueue::deleteHandler</a>(SIGCHLD, boost::ref(<a class="code" href="classNERD_1_1ConnectionServer.html#a87fc9625f6d518ffe294e4f759d3cae0" title="The functor that handles SIGCHLD signals when servers exit.">exitHandler</a>));
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     close(<a class="code" href="classNERD_1_1ConnectionServer.html#a3168fab5ca817d2cd2cb7ca15228440d" title="A socket bound to 127.0.0.1:MAGIC_PORT/TCP.">magic_sock</a>);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="comment">// shut down IPQ</span>
<a name="l00472"></a>00472     <span class="keywordflow">try</span>
<a name="l00473"></a>00473     {
<a name="l00474"></a>00474         <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a9a6fe5c8f61ae31fc59771f07fa37007" title="Close the libipq handle.">close</a>();
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqException.html" title="Base class for exceptions thrown by IPQ methods.">IPQ::IpqException</a>&amp; e)
<a name="l00477"></a>00477     {
<a name="l00478"></a>00478         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;%s&quot;</span>, e.what());
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 
<a name="l00489"></a>00489 <span class="keywordtype">void</span>
<a name="l00490"></a><a class="code" href="classNERD_1_1ConnectionServer.html#af506b23a0c81f40f8f449bb388005424">00490</a> <a class="code" href="classNERD_1_1ConnectionServer.html#af506b23a0c81f40f8f449bb388005424" title="Main loop for ConnectionServer.">ConnectionServer::operator()</a>()
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492     <span class="keywordflow">try</span>
<a name="l00493"></a>00493     {
<a name="l00494"></a>00494         <span class="comment">// loop forever, processing packets</span>
<a name="l00495"></a>00495         <span class="comment">// send the process a SIGINT to stop </span>
<a name="l00496"></a>00496         <span class="keywordflow">while</span> (1)
<a name="l00497"></a>00497         {
<a name="l00498"></a>00498 
<a name="l00499"></a>00499             <span class="keywordflow">try</span>
<a name="l00500"></a>00500             {
<a name="l00501"></a>00501                 <span class="comment">// wait for a packet, and handle signals that arrive.</span>
<a name="l00502"></a>00502                 <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a123e77a47324d0c765e191153659c040" title="Wait for a packet to become available.">waitForPacket</a>(<a class="code" href="classLibWheel_1_1SignalQueue.html#a36582b3985b30c6620ed3476b97e8538" title="Retrieve the read file descriptor of the signal pipe.">LibWheel::SignalQueue::getReadFD</a>(), <a class="code" href="classLibWheel_1_1SignalQueue.html#a991ba21066232f0db7be5f21e39edc41" title="Call all handlers for the next signal in the signal pipe.">LibWheel::SignalQueue::handleNext</a>);
<a name="l00503"></a>00503                 IPQ::IpqPacket* packet = <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#aff35b95d33b21474f844660fef28938c" title="Receive a packet from libipq.">recvPacket</a>(<span class="keyword">true</span>);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505                 <span class="comment">// handle the packet</span>
<a name="l00506"></a>00506                 <a class="code" href="classNERD_1_1ConnectionServer.html#a5b183a39539b07fe4a92ef3ad88d7c92" title="Handle a packet.">handlePacket</a>(packet);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508                 <span class="comment">// packet will be released and freed elsewhere</span>
<a name="l00509"></a>00509             }
<a name="l00510"></a>00510             <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqException.html" title="Base class for exceptions thrown by IPQ methods.">IPQ::IpqException</a>&amp; e)
<a name="l00511"></a>00511             {
<a name="l00512"></a>00512                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error processing packet: %s&quot;</span>, e.what());
<a name="l00513"></a>00513             }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classLibWheel_1_1Interrupt.html" title="Exception to be thrown in response to a SIGINT.">LibWheel::Interrupt</a>&amp; e) <span class="comment">// thrown when SIGINT is caught</span>
<a name="l00518"></a>00518     {
<a name="l00519"></a>00519         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a961460bd2878518cfe12504b1ab9de53" title="Normal, but significant, condition.">LibWheel::logmsg_notice</a>, <span class="stringliteral">&quot;SIGINT caught; exiting normally\n&quot;</span>);
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 
<a name="l00527"></a>00527 <span class="keywordtype">void</span>
<a name="l00528"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a52574c2792a324c56435234da19cc183">00528</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a52574c2792a324c56435234da19cc183" title="Print current server status to LibWheel::logmsg.">ConnectionServer::printStats</a>()<span class="keyword"> const</span>
<a name="l00529"></a>00529 <span class="keyword"></span>{
<a name="l00530"></a>00530     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;-----Current server status-----&quot;</span>);
<a name="l00531"></a>00531     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Total connections tracked:     %6d&quot;</span>, <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.size()/2);
<a name="l00532"></a>00532     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Connections awating deletion:  %6d&quot;</span>, <a class="code" href="classNERD_1_1ConnectionServer.html#adc22ef94ff5d014433eef07e054e1d69" title="A list of redirection rules to be deleted when timeouts expire.">timeoutList</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a21cf29a4959829a276799c989995c98c" title="Retrieves the number of elements in the list.">size</a>()/2);
<a name="l00533"></a>00533     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Connections pending:           %6d&quot;</span>, <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a21cf29a4959829a276799c989995c98c" title="Retrieves the number of elements in the list.">size</a>());
<a name="l00534"></a>00534     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Servers running:               %6d&quot;</span>, <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>.size());
<a name="l00535"></a>00535 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>    <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Open files:                    %6d&quot;</span>, <a class="code" href="namespaceLibWheel.html#a5f91ec312857b9f968bc17d795bc96e1" title="Counts the number of currently-open file descriptors.">LibWheel::open_files</a>());
<a name="l00537"></a>00537     <span class="comment">//struct rusage usage;</span>
<a name="l00538"></a>00538     <span class="comment">//(void)getrusage(RUSAGE_SELF, &amp;usage);</span>
<a name="l00539"></a>00539     <span class="comment">//LibWheel::logmsg(LibWheel::logmsg_info, &quot;Memory usage:                  %6ld kB&quot;, usage.ru_ixrss+usage.ru_idrss);</span>
<a name="l00540"></a>00540     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Packets received:              %6lu&quot;</span>, <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a9e664c8e6a5a549feb27d3052e7ff28b" title="Retrieve the number of packets that have been received from libipq.">getPacketsReceived</a>());
<a name="l00541"></a>00541     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Packets accepted:              %6lu&quot;</span>, <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a83b3c143170568625923218daf2c6864" title="Retrieve the number of packets for which a verdict of ACCEPT or STOP was set.">getPacketsAccepted</a>());
<a name="l00542"></a>00542     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Packets dropped:               %6lu&quot;</span>, <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a902f0bc0d1106b6da00ca4ce18a65ffa" title="Retrieve the number of packets for which a verdict of DROP was set.">getPacketsDropped</a>());
<a name="l00543"></a>00543 <span class="preprocessor">#endif</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span>}
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 
<a name="l00551"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html#aa102c5354baed9c1abde486991bd8616">00551</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html#aa102c5354baed9c1abde486991bd8616" title="Constructor for UnknownConnectionException.">ConnectionServer::UnknownConnectionException::UnknownConnectionException</a>(<span class="keyword">const</span> std::string&amp; s)
<a name="l00552"></a>00552 : runtime_error(s)
<a name="l00553"></a>00553 {}
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 
<a name="l00560"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownServerException.html#a776dc360b65b101756bdf5ed9ccf4f95">00560</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownServerException.html#a776dc360b65b101756bdf5ed9ccf4f95" title="Constructor for UnknownServerException.">ConnectionServer::UnknownServerException::UnknownServerException</a>(<span class="keyword">const</span> std::string&amp; s)
<a name="l00561"></a>00561 : runtime_error(s)
<a name="l00562"></a>00562 {}
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 
<a name="l00569"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a754684b80d70b7ec666a23cfcfce1362">00569</a> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a754684b80d70b7ec666a23cfcfce1362" title="Constructor for AddressPair.">ConnectionServer::AddressPair::AddressPair</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt)
<a name="l00570"></a>00570 : srcAddr(pkt-&gt;getIpHeader().saddr), dstAddr(pkt-&gt;getIpHeader().daddr), srcPort(pkt-&gt;getTcpHeader().source), dstPort(pkt-&gt;getTcpHeader().dest), protocol(IPPROTO_TCP)
<a name="l00571"></a>00571 {}
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 
<a name="l00582"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#ab6660cb88d8c3e0599010b533055f1ae">00582</a> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a754684b80d70b7ec666a23cfcfce1362" title="Constructor for AddressPair.">ConnectionServer::AddressPair::AddressPair</a>(boost::uint32_t sa, boost::uint32_t da, boost::uint16_t sp, boost::uint16_t dp, boost::uint8_t prot)
<a name="l00583"></a>00583 : srcAddr(sa), dstAddr(da), srcPort(sp), dstPort(dp), protocol(prot)
<a name="l00584"></a>00584 {}
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 
<a name="l00593"></a>00593 <span class="keywordtype">bool</span> 
<a name="l00594"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a39646b4ae1a85e00388f8282b50945b7">00594</a> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html#a39646b4ae1a85e00388f8282b50945b7" title="Comparison operator for AddressPair.">ConnectionServer::AddressPair::operator==</a>(<span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; b)<span class="keyword"> const</span>
<a name="l00595"></a>00595 <span class="keyword"></span>{
<a name="l00596"></a>00596     <span class="keywordflow">return</span> ((srcAddr == b.srcAddr)
<a name="l00597"></a>00597         &amp;&amp; (dstAddr == b.dstAddr)
<a name="l00598"></a>00598         &amp;&amp; (srcPort == b.srcPort)
<a name="l00599"></a>00599         &amp;&amp; (dstPort == b.dstPort)
<a name="l00600"></a>00600         &amp;&amp; (protocol == b.protocol));
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603 
<a name="l00611"></a>00611 <span class="keywordtype">size_t</span> 
<a name="l00612"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1AddressPairHash.html#a36bbb841fe3f2cbacb4cab2687675c4d">00612</a> <a class="code" href="classNERD_1_1ConnectionServer.html#af506b23a0c81f40f8f449bb388005424" title="Main loop for ConnectionServer.">ConnectionServer::AddressPairHash::operator()</a>(<span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; a)<span class="keyword"> const</span>
<a name="l00613"></a>00613 <span class="keyword"></span>{
<a name="l00614"></a>00614     <span class="keywordflow">return</span> hash32(a.srcAddr) ^ hash32(a.dstAddr) ^ hash16(a.srcPort) ^ (hash16(a.dstPort)&lt;&lt;16) ^ hash8(a.protocol);
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616     
<a name="l00617"></a>00617 
<a name="l00628"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a84d83200cead40def8a0eb1c4480f6e2">00628</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a84d83200cead40def8a0eb1c4480f6e2" title="Constructor for Connection.">ConnectionServer::Connection::Connection</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt, boost::uint32_t rsaddr, boost::uint32_t rdaddr, boost::uint16_t rsport, boost::uint16_t rdport, <span class="keyword">const</span> std::string&amp; name)
<a name="l00629"></a>00629 : forwardAddr(pkt), reverseAddr(rsaddr, rdaddr, rsport, rdport, IPPROTO_TCP), serverName(name)
<a name="l00630"></a>00630 {}
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 
<a name="l00639"></a>00639 <span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">::AddressPair</a>&amp;
<a name="l00640"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#af076490d2f7f9b23ed91ba3ff6452f9d">00640</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#af076490d2f7f9b23ed91ba3ff6452f9d" title="Retrieve the addresses of packets sent from a client to a server for a Connection.">ConnectionServer::Connection::getForwardAddr</a>()<span class="keyword"> const</span>
<a name="l00641"></a>00641 <span class="keyword"></span>{
<a name="l00642"></a>00642     <span class="keywordflow">return</span> forwardAddr;
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645  
<a name="l00652"></a>00652 <span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a><a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">::AddressPair</a>&amp;
<a name="l00653"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a4998c37ce0f55a17904ded653e5ea95b">00653</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a4998c37ce0f55a17904ded653e5ea95b" title="Retrieve the addresses of packets sent from a server to a client for a Connection.">ConnectionServer::Connection::getReverseAddr</a>()<span class="keyword"> const</span>
<a name="l00654"></a>00654 <span class="keyword"></span>{
<a name="l00655"></a>00655     <span class="keywordflow">return</span> reverseAddr;
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 
<a name="l00663"></a>00663 <span class="keyword">const</span> std::string&amp; 
<a name="l00664"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a1554fbce9d1ff09e21507fb372fd7077">00664</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html#a1554fbce9d1ff09e21507fb372fd7077" title="Retrieve the name of the server program handling a connection.">ConnectionServer::Connection::getName</a>()<span class="keyword"> const</span>
<a name="l00665"></a>00665 <span class="keyword"></span>{
<a name="l00666"></a>00666     <span class="keywordflow">return</span> serverName;
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669 
<a name="l00677"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#a1380579c5d0abbc5faaf130e7f9ad1eb">00677</a> <a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html#a1380579c5d0abbc5faaf130e7f9ad1eb" title="Constructor for PendingConnection.">ConnectionServer::PendingConnection::PendingConnection</a>(<a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt, <span class="keywordtype">int</span> fd, <span class="keyword">const</span> std::string&amp; name, pid_t p)
<a name="l00678"></a>00678 : packet(pkt), pipefd(fd), serverName(name), pid(p)
<a name="l00679"></a>00679 {}
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 
<a name="l00688"></a><a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a787396107afcb77da909db0fab301d9e">00688</a> <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a787396107afcb77da909db0fab301d9e" title="Constructor for ServerRecord.">ConnectionServer::ServerRecord::ServerRecord</a>(<span class="keyword">const</span> std::string&amp; addr, <span class="keyword">const</span> std::string&amp; port, <span class="keyword">const</span> std::string&amp; proto)
<a name="l00689"></a>00689 : serverAddr(addr), serverPort(port), serverProto(proto), serverProgram(), serverDnsRecord()
<a name="l00690"></a>00690 {}
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 
<a name="l00701"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a0a3634beb4eac3315afb6671205c399a">00701</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a0a3634beb4eac3315afb6671205c399a" title="Constructor for ServerExitHandler.">ConnectionServer::ServerExitHandler::ServerExitHandler</a>(<a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>&amp; pcl, <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>&amp; rt, <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>&amp; st, <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">TimeoutList</a>&amp; tl, <span class="keywordtype">bool</span> v)
<a name="l00702"></a>00702 : <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>(pcl), <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>(rt), <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>(st), <a class="code" href="classNERD_1_1ConnectionServer.html#adc22ef94ff5d014433eef07e054e1d69" title="A list of redirection rules to be deleted when timeouts expire.">timeoutList</a>(tl), <a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403" title="true to log extra messages; false otherwise">verbose</a>(v)
<a name="l00703"></a>00703 {}
<a name="l00704"></a>00704 
<a name="l00705"></a>00705 
<a name="l00718"></a>00718 <span class="keywordtype">void</span>
<a name="l00719"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#a9ca943b524de0b1f1907cecaab2943e1">00719</a> <a class="code" href="classNERD_1_1ConnectionServer.html#af506b23a0c81f40f8f449bb388005424" title="Main loop for ConnectionServer.">ConnectionServer::ServerExitHandler::operator()</a>()
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721     pid_t pid;
<a name="l00722"></a>00722     <span class="keywordtype">int</span> status;
<a name="l00723"></a>00723     
<a name="l00724"></a>00724     <span class="comment">// clean up after all servers that have exited</span>
<a name="l00725"></a>00725     <span class="keywordflow">do</span>
<a name="l00726"></a>00726     {
<a name="l00727"></a>00727         pid = waitpid(-1, &amp;status, WNOHANG);
<a name="l00728"></a>00728         <span class="keywordflow">if</span> (pid == -1)
<a name="l00729"></a>00729         {
<a name="l00730"></a>00730             <span class="comment">/* according to the man page, waitpid() is supposed to return 0 when</span>
<a name="l00731"></a>00731 <span class="comment">               WNOHANG is set and no processes have exited, but it seems to </span>
<a name="l00732"></a>00732 <span class="comment">               return -1 anyway */</span>
<a name="l00733"></a>00733             <span class="keywordflow">if</span> (errno != ECHILD)
<a name="l00734"></a>00734                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error retrieving process exit status: %s&quot;</span>, std::strerror(errno));
<a name="l00735"></a>00735         }
<a name="l00736"></a>00736         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid != 0) <span class="comment">// something exited</span>
<a name="l00737"></a>00737         {
<a name="l00738"></a>00738             <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>::iterator i = <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>.find(pid);
<a name="l00739"></a>00739             <span class="keywordflow">if</span> (i == <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>.end())
<a name="l00740"></a>00740             {
<a name="l00741"></a>00741                 <span class="comment">// not an active server; maybe it&#39;s pending?</span>
<a name="l00742"></a>00742                 <a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>::iterator j = findPendingConnection(pid);
<a name="l00743"></a>00743                 <span class="keywordflow">if</span> (j == <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a82a5b14fc1a9978a18dd6aa7fd62792d" title="Retrieves a bidirectional iterator to just past the end of the list.">end</a>())
<a name="l00744"></a>00744                 {
<a name="l00745"></a>00745                     <span class="comment">// out of options</span>
<a name="l00746"></a>00746                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;No server record found for child pid %d&quot;</span>, pid);
<a name="l00747"></a>00747                 }
<a name="l00748"></a>00748                 <span class="keywordflow">else</span>
<a name="l00749"></a>00749                 {
<a name="l00750"></a>00750                     <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a975195ad3a9b2c38453291a1633cf78b" title="Removes an object from the list.">erase</a>(j);
<a name="l00751"></a>00751                 }
<a name="l00752"></a>00752             }
<a name="l00753"></a>00753             <span class="keywordflow">else</span>
<a name="l00754"></a>00754             {
<a name="l00755"></a>00755                 <span class="comment">// check for abnornal termination</span>
<a name="l00756"></a>00756                 <span class="keywordflow">if</span> (WIFSIGNALED(status))
<a name="l00757"></a>00757                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;Server %s (pid %d) exited abnormally by signal %d&quot;</span>, i-&gt;second.getName().c_str(), pid, WTERMSIG(status));
<a name="l00758"></a>00758                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WIFEXITED(status) &amp;&amp; (WEXITSTATUS(status) != EXIT_SUCCESS))
<a name="l00759"></a>00759                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;Server %s (pid %d) exited abnormally with status %d&quot;</span>, i-&gt;second.getName().c_str(), pid, WEXITSTATUS(status));
<a name="l00760"></a>00760                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403" title="true to log extra messages; false otherwise">verbose</a>)
<a name="l00761"></a>00761                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a961460bd2878518cfe12504b1ab9de53" title="Normal, but significant, condition.">LibWheel::logmsg_notice</a>, <span class="stringliteral">&quot;Server %s (pid %d) exited normally&quot;</span>, i-&gt;second.getName().c_str(), pid);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763                 <span class="comment">// remove connection entries</span>
<a name="l00764"></a>00764                 <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>::iterator redir = <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.find(i-&gt;second.getForwardAddr());
<a name="l00765"></a>00765                 <span class="keywordflow">if</span> (redir == <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.end())
<a name="l00766"></a>00766                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;No forward connection found&quot;</span>);
<a name="l00767"></a>00767                 <span class="keywordflow">else</span>
<a name="l00768"></a>00768                     <a class="code" href="classNERD_1_1ConnectionServer.html#adc22ef94ff5d014433eef07e054e1d69" title="A list of redirection rules to be deleted when timeouts expire.">timeoutList</a>.<a class="code" href="classLibWheel_1_1WaitList.html#ac2f908037eee4e5c5d6553c217647c1b" title="Adds an object to the back of the list.">add</a>(std::make_pair(&amp;<a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>, redir));
<a name="l00769"></a>00769                 redir = <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.find(i-&gt;second.getReverseAddr());
<a name="l00770"></a>00770                 <span class="keywordflow">if</span> (redir == <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.end())
<a name="l00771"></a>00771                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;No reverse connection found&quot;</span>);
<a name="l00772"></a>00772                 <span class="keywordflow">else</span>
<a name="l00773"></a>00773                     <a class="code" href="classNERD_1_1ConnectionServer.html#adc22ef94ff5d014433eef07e054e1d69" title="A list of redirection rules to be deleted when timeouts expire.">timeoutList</a>.<a class="code" href="classLibWheel_1_1WaitList.html#ac2f908037eee4e5c5d6553c217647c1b" title="Adds an object to the back of the list.">add</a>(std::make_pair(&amp;<a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>, redir));
<a name="l00774"></a>00774 
<a name="l00775"></a>00775                 <span class="comment">// remove the server entry;</span>
<a name="l00776"></a>00776                 <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>.erase(i);
<a name="l00777"></a>00777             }
<a name="l00778"></a>00778         }
<a name="l00779"></a>00779     } <span class="keywordflow">while</span> (pid &gt; 0);
<a name="l00780"></a>00780 }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 
<a name="l00790"></a>00790 <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a><a class="code" href="classLibWheel_1_1WaitList.html#a197f2582847b549a89b833d2eb153b1c" title="A type describing a bidirectional iterator for the list.">::PendingConnectionList::iterator</a>
<a name="l00791"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#ac380cd94aeac14ce16c7d957d999941c">00791</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerExitHandler.html#ac380cd94aeac14ce16c7d957d999941c" title="Look up a pending connection given the PID of its server.">ConnectionServer::ServerExitHandler::findPendingConnection</a>(pid_t pid)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793     <span class="keywordflow">for</span> (<a class="code" href="classLibWheel_1_1WaitList.html#a197f2582847b549a89b833d2eb153b1c" title="A type describing a bidirectional iterator for the list.">PendingConnectionList::iterator</a> i=<a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#ae258ef53fb5bd852f91176247627ecea" title="Retrieves a bidirectional iterator to the beginning of the list.">begin</a>(); i!=<a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a82a5b14fc1a9978a18dd6aa7fd62792d" title="Retrieves a bidirectional iterator to just past the end of the list.">end</a>(); ++i)
<a name="l00794"></a>00794     {
<a name="l00795"></a>00795         <span class="keywordflow">if</span> (i-&gt;value.pid == pid)
<a name="l00796"></a>00796             <span class="keywordflow">return</span> i;
<a name="l00797"></a>00797     }
<a name="l00798"></a>00798     <span class="keywordflow">return</span> <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a82a5b14fc1a9978a18dd6aa7fd62792d" title="Retrieves a bidirectional iterator to just past the end of the list.">end</a>();
<a name="l00799"></a>00799 }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801 
<a name="l00809"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#ab92b47891071f80818d7bde25cae902c">00809</a> <a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#ab92b47891071f80818d7bde25cae902c" title="Constructor for ServerWritebackHandler.">ConnectionServer::ServerWritebackHandler::ServerWritebackHandler</a>(<a class="code" href="classLibWheel_1_1WaitList.html" title="A list from which items will be removed after a timeout.">PendingConnectionList</a>&amp; pcl, <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>&amp; rt, <a class="code" href="classNERD_1_1ConnectionServer.html#a0cd661f2a6755c501ac198229675ad4d" title="A look-up table mapping server process IDs to the connections that they manage.">ServerTable</a>&amp; st, <a class="code" href="classIPQ_1_1IpqSocket.html" title="A program&#39;s link to libipq.">IPQ::IpqSocket</a>&amp; s)
<a name="l00810"></a>00810 : <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>(pcl), <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>(rt), <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>(st), <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>(s)
<a name="l00811"></a>00811 {}
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 
<a name="l00824"></a>00824 <span class="keywordtype">void</span>
<a name="l00825"></a><a class="code" href="classNERD_1_1ConnectionServer_1_1ServerWritebackHandler.html#addc9ae778c4e9375c4499dab4eef2074">00825</a> <a class="code" href="classNERD_1_1ConnectionServer.html#af506b23a0c81f40f8f449bb388005424" title="Main loop for ConnectionServer.">ConnectionServer::ServerWritebackHandler::operator()</a>()
<a name="l00826"></a>00826 {
<a name="l00827"></a>00827     <span class="keywordtype">int</span> retval;
<a name="l00828"></a>00828     boost::uint16_t port;
<a name="l00829"></a>00829     
<a name="l00830"></a>00830     <span class="comment">// check for clients that have responded and create connection records for them</span>
<a name="l00831"></a>00831     <span class="keywordflow">for</span> (<a class="code" href="classLibWheel_1_1WaitList.html#a197f2582847b549a89b833d2eb153b1c" title="A type describing a bidirectional iterator for the list.">PendingConnectionList::iterator</a> i=<a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#ae258ef53fb5bd852f91176247627ecea" title="Retrieves a bidirectional iterator to the beginning of the list.">begin</a>(); i!=<a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a82a5b14fc1a9978a18dd6aa7fd62792d" title="Retrieves a bidirectional iterator to just past the end of the list.">end</a>(); )
<a name="l00832"></a>00832     {
<a name="l00833"></a>00833         <span class="comment">// try to read a port number</span>
<a name="l00834"></a>00834         retval = <a class="code" href="namespaceLibWheel.html#a5103fe133e672ffe84edc3977969c244" title="Read data from a file descriptor.">LibWheel::uninterruptible_read</a>(i-&gt;value.pipefd, reinterpret_cast&lt;boost::uint8_t*&gt;(&amp;port), 2);
<a name="l00835"></a>00835         <span class="keywordflow">if</span> (retval == -1)
<a name="l00836"></a>00836         {
<a name="l00837"></a>00837             <span class="keywordflow">if</span> (errno != EAGAIN)
<a name="l00838"></a>00838             {
<a name="l00839"></a>00839                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error reading from server (pid %d): %s&quot;</span>, i-&gt;value.pid, std::strerror(errno));
<a name="l00840"></a>00840                 i = <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a975195ad3a9b2c38453291a1633cf78b" title="Removes an object from the list.">erase</a>(i);
<a name="l00841"></a>00841             }
<a name="l00842"></a>00842             <span class="keywordflow">else</span>
<a name="l00843"></a>00843             {
<a name="l00844"></a>00844                 ++i;
<a name="l00845"></a>00845             }
<a name="l00846"></a>00846         }
<a name="l00847"></a>00847         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (retval != 2)
<a name="l00848"></a>00848         {
<a name="l00849"></a>00849             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error reading from server (pid %d): message truncated&quot;</span>, i-&gt;value.pid);
<a name="l00850"></a>00850             i = <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a975195ad3a9b2c38453291a1633cf78b" title="Removes an object from the list.">erase</a>(i);
<a name="l00851"></a>00851         }
<a name="l00852"></a>00852         <span class="keywordflow">else</span>
<a name="l00853"></a>00853         {
<a name="l00854"></a>00854             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Forwarding TCP connection %s:%hu-&gt;%s:%hu to 127.0.0.1:%hu&quot;</span>, <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(i-&gt;value.packet-&gt;getIpSource()).c_str(), i-&gt;value.packet-&gt;getTcpSource(), <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(i-&gt;value.packet-&gt;getIpDest()).c_str(), i-&gt;value.packet-&gt;getTcpDest(), ntohs(port));
<a name="l00855"></a>00855 
<a name="l00856"></a>00856             <span class="comment">// create a connection</span>
<a name="l00857"></a>00857             <a class="code" href="classNERD_1_1ConnectionServer_1_1Connection.html" title="A description of a connection managed by a server program.">Connection</a> conn(i-&gt;value.packet.get(), htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>), htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>), port, htons(<a class="code" href="nerd_8cpp.html#a5a7162a4cf2bc5e6950e2bf63c1ca47d" title="To servers, client connections will appear to come from this port on localhost.">MAGIC_PORT</a>), i-&gt;value.serverName);
<a name="l00858"></a>00858             <a class="code" href="classNERD_1_1ConnectionServer.html#a990a4882c5123f35208d36cabb5fef67" title="A hash table of server process IDs and the connections that they handle.">servers</a>.insert(std::make_pair(i-&gt;value.pid, conn));
<a name="l00859"></a>00859             <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.insert(std::make_pair(conn.getForwardAddr(), <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>(htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>), htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>), htons(<a class="code" href="nerd_8cpp.html#a5a7162a4cf2bc5e6950e2bf63c1ca47d" title="To servers, client connections will appear to come from this port on localhost.">MAGIC_PORT</a>), port, IPPROTO_TCP)));
<a name="l00860"></a>00860             <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.insert(std::make_pair(conn.getReverseAddr(), <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>(i-&gt;value.packet-&gt;getIpHeader().daddr, i-&gt;value.packet-&gt;getIpHeader().saddr, i-&gt;value.packet-&gt;getTcpHeader().dest, i-&gt;value.packet-&gt;getTcpHeader().source, IPPROTO_TCP)));
<a name="l00861"></a>00861 
<a name="l00862"></a>00862             <span class="comment">// forward the packet</span>
<a name="l00863"></a>00863             i-&gt;value.packet-&gt;getIpHeader().saddr = htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>);
<a name="l00864"></a>00864             i-&gt;value.packet-&gt;getIpHeader().daddr = htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>);
<a name="l00865"></a>00865             i-&gt;value.packet-&gt;getTcpHeader().source = htons(<a class="code" href="nerd_8cpp.html#a5a7162a4cf2bc5e6950e2bf63c1ca47d" title="To servers, client connections will appear to come from this port on localhost.">MAGIC_PORT</a>);
<a name="l00866"></a>00866             i-&gt;value.packet-&gt;getTcpHeader().dest = port;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868             <span class="comment">// release the packet to continue iptables traversal</span>
<a name="l00869"></a>00869             <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(i-&gt;value.packet.get(), IPQ::IpqSocket::ACCEPT);
<a name="l00870"></a>00870 
<a name="l00871"></a>00871             i = <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#a975195ad3a9b2c38453291a1633cf78b" title="Removes an object from the list.">erase</a>(i);
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 
<a name="l00893"></a>00893 <span class="keywordtype">void</span>
<a name="l00894"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a5b183a39539b07fe4a92ef3ad88d7c92">00894</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a5b183a39539b07fe4a92ef3ad88d7c92" title="Handle a packet.">ConnectionServer::handlePacket</a>(<a class="code" href="classIPQ_1_1IpqPacket.html" title="Base class for packets received via IpqSocket.">IPQ::IpqPacket</a>* packet)
<a name="l00895"></a>00895 {
<a name="l00896"></a>00896     IPQ::IpqIpPacket* ippkt = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classIPQ_1_1IpqIpPacket.html" title="A complete IPv4 packet received via IpqSocket.">IPQ::IpqIpPacket</a>*<span class="keyword">&gt;</span>(packet);
<a name="l00897"></a>00897     
<a name="l00898"></a>00898     <span class="keywordflow">if</span> (ippkt != NULL)
<a name="l00899"></a>00899     {
<a name="l00900"></a>00900         IPQ::IpqTcpPacket* tcppkt;
<a name="l00901"></a>00901         IPQ::IpqUdpPacket* udppkt;
<a name="l00902"></a>00902 
<a name="l00903"></a>00903         <span class="keywordflow">if</span> (ippkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a76e0d09916fc816df3dab46cb29d479f" title="Retrieve the &quot;more fragments to follow&quot; flag of a packet.">getMoreFrags</a>() || (ippkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a97e6e13ede2c6c6f028ee0eb1130600b" title="Retrieve the fragment offset of a packet, in bytes.">getFragOffset</a>() != 0))
<a name="l00904"></a>00904         {
<a name="l00905"></a>00905             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;IP fragment reassembly is not supported at this time&quot;</span>);
<a name="l00906"></a>00906             <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(packet, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l00907"></a>00907             <span class="keyword">delete</span> packet;
<a name="l00908"></a>00908         }
<a name="l00909"></a>00909         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((tcppkt = dynamic_cast&lt;IPQ::IpqTcpPacket*&gt;(packet)) != NULL)
<a name="l00910"></a>00910         {
<a name="l00911"></a>00911             <span class="keywordflow">try</span>
<a name="l00912"></a>00912             {
<a name="l00913"></a>00913                 <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; rule = <a class="code" href="classNERD_1_1ConnectionServer.html#afd85b7ad69696355650a0177d01f0a06" title="Looks up a redirection rule for a TCP packet.">getRedirectRule</a>(tcppkt);
<a name="l00914"></a>00914                 
<a name="l00915"></a>00915                 <span class="comment">// re-write the packet&#39;s source and destination addresses</span>
<a name="l00916"></a>00916                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Rewriting addresses of TCP packet %s:%hu-&gt;%s:%hu to %s:%hu-&gt;%s:%hu&quot;</span>, <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a4708c5a987eb9796566e2b3bdd072589" title="Retrieve the source IP address of a packet.">getIpSource</a>()).c_str(), tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a970d80b0be1859f4b2a78d4784295872" title="Retrieve the TCP source port of a packet.">getTcpSource</a>(), <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a056bedcbf7998452d147f2d2ef68b611" title="Retrieve the destination IP address of a packet.">getIpDest</a>()).c_str(), tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#ad2fc945448bbfc68a682bf6cd354f35f" title="Retrieve the TCP destination port of a packet.">getTcpDest</a>(), <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(ntohl(rule.srcAddr)).c_str(), ntohs(rule.srcPort), <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(ntohl(rule.dstAddr)).c_str(), ntohs(rule.dstPort));
<a name="l00917"></a>00917                     
<a name="l00918"></a>00918                 tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#abf46954191d96b4e2fe136f79ba6c8ac" title="Retrieve the complete IP header of a packet.">getIpHeader</a>().saddr = rule.srcAddr;
<a name="l00919"></a>00919                 tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#abf46954191d96b4e2fe136f79ba6c8ac" title="Retrieve the complete IP header of a packet.">getIpHeader</a>().daddr = rule.dstAddr;
<a name="l00920"></a>00920                 tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().source = rule.srcPort;
<a name="l00921"></a>00921                 tcppkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().dest = rule.dstPort;
<a name="l00922"></a>00922                     
<a name="l00923"></a>00923                 <span class="comment">// release the packet to continue iptables traversal</span>
<a name="l00924"></a>00924                 <span class="keywordflow">if</span> (rule.srcAddr == htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>))
<a name="l00925"></a>00925                 {
<a name="l00926"></a>00926                     <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(packet, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l00927"></a>00927                 }
<a name="l00928"></a>00928                 <span class="keywordflow">else</span>
<a name="l00929"></a>00929                 {
<a name="l00930"></a>00930                     <span class="comment">// this should really be ACCEPT, but netfilter has a bug </span>
<a name="l00931"></a>00931                     <span class="comment">// that causes packets on local output with non-local source </span>
<a name="l00932"></a>00932                     <span class="comment">// addresses to be dropped; the work-around is to return </span>
<a name="l00933"></a>00933                     <span class="comment">// NF_STOP</span>
<a name="l00934"></a>00934                     <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(packet, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2de248ccae41d7a288cda6a629ecdcf5" title="Accept the packet, but don&#39;t continue iptables traversal.">IPQ::IpqSocket::STOP</a>);
<a name="l00935"></a>00935                 }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937                 <span class="keyword">delete</span> packet;
<a name="l00938"></a>00938             }
<a name="l00939"></a>00939             <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html" title="Exception thrown by getRedirectRule() when a packet does not match any existing connection record...">UnknownConnectionException</a>&amp; e)
<a name="l00940"></a>00940             {
<a name="l00941"></a>00941                 <a class="code" href="classNERD_1_1ConnectionServer.html#af4ba681fed213914c83661a1dfd8df6d" title="Creates a TCP connection.">createConnection</a>(tcppkt);
<a name="l00942"></a>00942             }
<a name="l00943"></a>00943         }
<a name="l00944"></a>00944         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((udppkt = dynamic_cast&lt;IPQ::IpqUdpPacket*&gt;(packet)) != NULL)
<a name="l00945"></a>00945         {
<a name="l00946"></a>00946             <span class="keywordflow">try</span>
<a name="l00947"></a>00947             {
<a name="l00948"></a>00948                 <span class="keyword">const</span> <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a>&amp; rule = <a class="code" href="classNERD_1_1ConnectionServer.html#afd85b7ad69696355650a0177d01f0a06" title="Looks up a redirection rule for a TCP packet.">getRedirectRule</a>(udppkt);
<a name="l00949"></a>00949                 
<a name="l00950"></a>00950                 <span class="comment">// re-write the packet&#39;s source and destination addresses</span>
<a name="l00951"></a>00951                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Rewriting addresses of UDP packet %s:%hu-&gt;%s:%hu to %s:%hu-&gt;%s:%hu&quot;</span>, <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(udppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a4708c5a987eb9796566e2b3bdd072589" title="Retrieve the source IP address of a packet.">getIpSource</a>()).c_str(), udppkt-&gt;<a class="code" href="classIPQ_1_1IpqUdpPacket.html#a4418916762f64f6996bd5cb1d7102c6e" title="Retrieve the UDP source port of a packet.">getUdpSource</a>(), <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(udppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a056bedcbf7998452d147f2d2ef68b611" title="Retrieve the destination IP address of a packet.">getIpDest</a>()).c_str(), udppkt-&gt;<a class="code" href="classIPQ_1_1IpqUdpPacket.html#aaf059aaa0d6027dd23e701c691ad07a7" title="Retrieve the UDP destination port of a packet.">getUdpDest</a>(), <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(ntohl(rule.srcAddr)).c_str(), ntohs(rule.srcPort), <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(ntohl(rule.dstAddr)).c_str(), ntohs(rule.dstPort));
<a name="l00952"></a>00952                 
<a name="l00953"></a>00953                 udppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#abf46954191d96b4e2fe136f79ba6c8ac" title="Retrieve the complete IP header of a packet.">getIpHeader</a>().saddr = rule.srcAddr;
<a name="l00954"></a>00954                 udppkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#abf46954191d96b4e2fe136f79ba6c8ac" title="Retrieve the complete IP header of a packet.">getIpHeader</a>().daddr = rule.dstAddr;
<a name="l00955"></a>00955                 udppkt-&gt;<a class="code" href="classIPQ_1_1IpqUdpPacket.html#a88d136acc4488ec965f1d9d3acdc1c33" title="Retrieve the complete UDP header of a packet.">getUdpHeader</a>().source = rule.srcPort;
<a name="l00956"></a>00956                 udppkt-&gt;<a class="code" href="classIPQ_1_1IpqUdpPacket.html#a88d136acc4488ec965f1d9d3acdc1c33" title="Retrieve the complete UDP header of a packet.">getUdpHeader</a>().dest = rule.dstPort;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958                 <span class="comment">// release the packet to continue iptables traversal</span>
<a name="l00959"></a>00959                 <span class="keywordflow">if</span> (rule.srcAddr == htonl(<a class="code" href="nerd_8cpp.html#a478277e1db3d0efd1a610e6254a7fe54" title="127.0.0.1, as an integer in HBO.">LOCALHOST_IP</a>))
<a name="l00960"></a>00960                 {
<a name="l00961"></a>00961                     <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(packet, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l00962"></a>00962                 }
<a name="l00963"></a>00963                 <span class="keywordflow">else</span>
<a name="l00964"></a>00964                 {
<a name="l00965"></a>00965                     <span class="comment">// this should really be ACCEPT, but netfilter has a bug </span>
<a name="l00966"></a>00966                     <span class="comment">// that causes packets on local output with non-local source </span>
<a name="l00967"></a>00967                     <span class="comment">// addresses to be dropped; the work-around is to return </span>
<a name="l00968"></a>00968                     <span class="comment">// NF_STOP</span>
<a name="l00969"></a>00969                     <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(packet, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2de248ccae41d7a288cda6a629ecdcf5" title="Accept the packet, but don&#39;t continue iptables traversal.">IPQ::IpqSocket::STOP</a>);
<a name="l00970"></a>00970                 }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972                 <span class="keyword">delete</span> packet;
<a name="l00973"></a>00973             }
<a name="l00974"></a>00974             <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html" title="Exception thrown by getRedirectRule() when a packet does not match any existing connection record...">UnknownConnectionException</a>&amp; e)
<a name="l00975"></a>00975             {
<a name="l00976"></a>00976                 <a class="code" href="classNERD_1_1ConnectionServer.html#af4ba681fed213914c83661a1dfd8df6d" title="Creates a TCP connection.">createConnection</a>(udppkt);
<a name="l00977"></a>00977             }
<a name="l00978"></a>00978         }
<a name="l00979"></a>00979         <span class="keywordflow">else</span>
<a name="l00980"></a>00980         {
<a name="l00981"></a>00981             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;Packet received with unsupported transport protocol #%hu&quot;</span>, ippkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#aefa78bb7a89a337bb0c1d88c02d6d5cd" title="Retrieve the encapsulated protocol number of a packet.">getProtocol</a>());
<a name="l00982"></a>00982             <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(packet, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l00983"></a>00983             <span class="keyword">delete</span> packet;
<a name="l00984"></a>00984         }
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986     <span class="keywordflow">else</span>
<a name="l00987"></a>00987     {
<a name="l00988"></a>00988         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;Non-IP packet received\n&quot;</span>);
<a name="l00989"></a>00989         <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(packet, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l00990"></a>00990         <span class="keyword">delete</span> packet;
<a name="l00991"></a>00991     }
<a name="l00992"></a>00992 }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 
<a name="l01001"></a>01001 <span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a>::AddressPair&amp;
<a name="l01002"></a><a class="code" href="classNERD_1_1ConnectionServer.html#afd85b7ad69696355650a0177d01f0a06">01002</a> <a class="code" href="classNERD_1_1ConnectionServer.html#afd85b7ad69696355650a0177d01f0a06" title="Looks up a redirection rule for a TCP packet.">ConnectionServer::getRedirectRule</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt) <span class="keyword">const</span> <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html" title="Exception thrown by getRedirectRule() when a packet does not match any existing connection record...">UnknownConnectionException</a>))
<a name="l01003"></a>01003 {
<a name="l01004"></a>01004     <a class="code" href="structNERD_1_1ConnectionServer_1_1AddressPair.html" title="The source and destination addresses of IP packets travelling in one direction in a connection...">AddressPair</a> addr(pkt);
<a name="l01005"></a>01005     <a class="code" href="classNERD_1_1ConnectionServer.html#a1f7b6abdda0f0a7a027a5f2e24727cee" title="A look-up table mapping the addresses of packets to redirection rules.">RedirectionTable</a>::const_iterator result = <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.find(addr);
<a name="l01006"></a>01006     <span class="keywordflow">if</span> (result != <a class="code" href="classNERD_1_1ConnectionServer.html#a4186be4b373165c72ab81a73165cb075" title="A hash table of rules governing packet redirections for open conncetions.">redirections</a>.end())
<a name="l01007"></a>01007         <span class="keywordflow">return</span> result-&gt;second;
<a name="l01008"></a>01008     
<a name="l01009"></a>01009     <span class="keywordflow">throw</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html" title="Exception thrown by getRedirectRule() when a packet does not match any existing connection record...">UnknownConnectionException</a>(<span class="stringliteral">&quot;No matching connection found&quot;</span>);
<a name="l01010"></a>01010 }
<a name="l01011"></a>01011 
<a name="l01012"></a>01012 
<a name="l01022"></a>01022 <span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a>::AddressPair&amp;
<a name="l01023"></a><a class="code" href="classNERD_1_1ConnectionServer.html#aca2ea51c7622b3ecb11cbaa976b9a137">01023</a> <a class="code" href="classNERD_1_1ConnectionServer.html#afd85b7ad69696355650a0177d01f0a06" title="Looks up a redirection rule for a TCP packet.">ConnectionServer::getRedirectRule</a>(<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqUdpPacket.html" title="An complete IPv4/UDP packet that was received via IpqSocket.">IPQ::IpqUdpPacket</a>*) const <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownConnectionException.html" title="Exception thrown by getRedirectRule() when a packet does not match any existing connection record...">UnknownConnectionException</a>))
<a name="l01024"></a>01024 {
<a name="l01025"></a>01025     <span class="keywordflow">throw</span> UnknownConnectionException(<span class="stringliteral">&quot;No matching connection found&quot;</span>);
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 
<a name="l01061"></a>01061 <span class="keywordtype">void</span> 
<a name="l01062"></a><a class="code" href="classNERD_1_1ConnectionServer.html#af4ba681fed213914c83661a1dfd8df6d">01062</a> <a class="code" href="classNERD_1_1ConnectionServer.html#af4ba681fed213914c83661a1dfd8df6d" title="Creates a TCP connection.">ConnectionServer::createConnection</a>(<a class="code" href="classIPQ_1_1IpqTcpPacket.html" title="An complete IPv4/TCP packet that was received via IpqSocket.">IPQ::IpqTcpPacket</a>* pkt)
<a name="l01063"></a>01063 {
<a name="l01064"></a>01064     <span class="keywordtype">int</span> retval;
<a name="l01065"></a>01065     <span class="keywordtype">int</span> fds[2];
<a name="l01066"></a>01066     pid_t child_pid;
<a name="l01067"></a>01067     
<a name="l01068"></a>01068     <span class="comment">/*pkt-&gt;print(std::cout);</span>
<a name="l01069"></a>01069 <span class="comment">    std::cout &lt;&lt; std::endl;*/</span>
<a name="l01070"></a>01070     
<a name="l01071"></a>01071     <span class="comment">// make sure we&#39;re looking at a SYN packet</span>
<a name="l01072"></a>01072     <span class="keywordflow">if</span> (!pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().syn || pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().fin || pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().rst
<a name="l01073"></a>01073       || pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().psh || pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().ack || pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#a10987837a2b53336b43d059a74d00808" title="Retrieve the complete TCP header of a packet.">getTcpHeader</a>().urg)
<a name="l01074"></a>01074     {
<a name="l01075"></a>01075         <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403" title="true to log extra messages; false otherwise">verbose</a>)
<a name="l01076"></a>01076             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot create TCP connection: not a SYN packet&quot;</span>);
<a name="l01077"></a>01077         <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(pkt, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l01078"></a>01078         <span class="keyword">delete</span> pkt;
<a name="l01079"></a>01079         <span class="keywordflow">return</span>;
<a name="l01080"></a>01080     }
<a name="l01081"></a>01081     
<a name="l01082"></a>01082     <span class="keywordflow">try</span>
<a name="l01083"></a>01083     {
<a name="l01084"></a>01084         <span class="comment">// get the name of the server to run</span>
<a name="l01085"></a>01085         <a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html" title="Information about a server program to be started.">ServerRecord</a> server(<a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(pkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a056bedcbf7998452d147f2d2ef68b611" title="Retrieve the destination IP address of a packet.">getIpDest</a>()), boost::lexical_cast&lt;std::string&gt;(pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#ad2fc945448bbfc68a682bf6cd354f35f" title="Retrieve the TCP destination port of a packet.">getTcpDest</a>()), <span class="stringliteral">&quot;TCP&quot;</span>);
<a name="l01086"></a>01086         <a class="code" href="classNERD_1_1ConnectionServer.html#a9d75b0d048d374095c4d7c96e4add7f8" title="Attempts to find a server program to run in response to a connection request.">findServer</a>(server, pkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a056bedcbf7998452d147f2d2ef68b611" title="Retrieve the destination IP address of a packet.">getIpDest</a>());
<a name="l01087"></a>01087         
<a name="l01088"></a>01088         <span class="comment">// set up a pipe</span>
<a name="l01089"></a>01089         retval = pipe(fds);
<a name="l01090"></a>01090         <span class="keywordflow">if</span> (retval == -1)
<a name="l01091"></a>01091         {
<a name="l01092"></a>01092             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot launch server: Error opening pipe: %s&quot;</span>, std::strerror(errno));
<a name="l01093"></a>01093             <span class="keyword">delete</span> pkt;
<a name="l01094"></a>01094             <span class="keywordflow">return</span>;
<a name="l01095"></a>01095         }
<a name="l01096"></a>01096         retval = fcntl(fds[0], F_SETOWN, getpid());
<a name="l01097"></a>01097         <span class="keywordflow">if</span> (retval == -1)
<a name="l01098"></a>01098         {
<a name="l01099"></a>01099             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot launch server: Error configuring pipe: %s&quot;</span>, std::strerror(errno));
<a name="l01100"></a>01100             <span class="keyword">delete</span> pkt;
<a name="l01101"></a>01101             <span class="keywordflow">return</span>;
<a name="l01102"></a>01102         }
<a name="l01103"></a>01103         retval = fcntl(fds[0], F_SETFL, O_ASYNC|O_NONBLOCK);
<a name="l01104"></a>01104         <span class="keywordflow">if</span> (retval == -1)
<a name="l01105"></a>01105         {
<a name="l01106"></a>01106             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot launch server: Error configuring pipe: %s&quot;</span>, std::strerror(errno));
<a name="l01107"></a>01107             <span class="keyword">delete</span> pkt;
<a name="l01108"></a>01108             <span class="keywordflow">return</span>;
<a name="l01109"></a>01109         }
<a name="l01110"></a>01110         
<a name="l01111"></a>01111         <span class="comment">// fork a child process</span>
<a name="l01112"></a>01112         child_pid = fork();
<a name="l01113"></a>01113         <span class="keywordflow">if</span> (child_pid == -1)
<a name="l01114"></a>01114         {
<a name="l01115"></a>01115             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot launch server: Error forking: %s&quot;</span>, std::strerror(errno));
<a name="l01116"></a>01116             <span class="keyword">delete</span> pkt;
<a name="l01117"></a>01117             <span class="keywordflow">return</span>;
<a name="l01118"></a>01118         }
<a name="l01119"></a>01119         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (child_pid != 0) <span class="comment">// parent process</span>
<a name="l01120"></a>01120         {
<a name="l01121"></a>01121             <span class="comment">// close the write end of the pipe</span>
<a name="l01122"></a>01122             retval = <a class="code" href="namespaceLibWheel.html#a6941e854dd6b671e040bcffd561c22e5" title="Close a file descriptor.">LibWheel::uninterruptible_close</a>(fds[1]);
<a name="l01123"></a>01123             <span class="keywordflow">if</span> (retval == -1)
<a name="l01124"></a>01124             {
<a name="l01125"></a>01125                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error closing pipe: %s&quot;</span>, std::strerror(errno));
<a name="l01126"></a>01126             }
<a name="l01127"></a>01127             
<a name="l01128"></a>01128             <span class="comment">// store connection metadata for signal handler</span>
<a name="l01129"></a>01129             <span class="comment">// It&#39;s not a bug to add this to the list after the fork, because</span>
<a name="l01130"></a>01130             <span class="comment">// SIGIO is handled synchronously (by SignalQueue).</span>
<a name="l01131"></a>01131             <a class="code" href="classNERD_1_1ConnectionServer.html#ad051d0ac714b53904e86c368cd90275c" title="The list of servers (and associated initial packets) which have been started but have not yet respond...">pendingConnections</a>.<a class="code" href="classLibWheel_1_1WaitList.html#ac2f908037eee4e5c5d6553c217647c1b" title="Adds an object to the back of the list.">add</a>(<a class="code" href="structNERD_1_1ConnectionServer_1_1PendingConnection.html" title="Information pertaining to a server that is starting up to handle a connection.">PendingConnection</a>(pkt, fds[0], server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>, child_pid));
<a name="l01132"></a>01132     
<a name="l01133"></a>01133             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;Launching server %s&quot;</span>, server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str());
<a name="l01134"></a>01134         }
<a name="l01135"></a>01135         <span class="keywordflow">else</span> <span class="comment">// child process </span>
<a name="l01136"></a>01136         {
<a name="l01137"></a>01137             <span class="keyword">struct </span>stat linkstat;
<a name="l01138"></a>01138             <span class="keyword">struct </span>stat filestat;
<a name="l01139"></a>01139             <span class="keywordtype">int</span> server_fd;
<a name="l01140"></a>01140             <span class="keywordtype">char</span>* server_args[5];
<a name="l01141"></a>01141             <span class="keywordtype">char</span>* server_env[1];
<a name="l01142"></a>01142                 
<a name="l01143"></a>01143             <span class="comment">// close the read end of the pipe and set the write end to NERD_PIPE_FD</span>
<a name="l01144"></a>01144             retval = <a class="code" href="namespaceLibWheel.html#a6941e854dd6b671e040bcffd561c22e5" title="Close a file descriptor.">LibWheel::uninterruptible_close</a>(fds[0]);
<a name="l01145"></a>01145             <span class="keywordflow">if</span> (retval == -1)
<a name="l01146"></a>01146             {
<a name="l01147"></a>01147                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error closing pipe: %s&quot;</span>, std::strerror(errno));
<a name="l01148"></a>01148             }
<a name="l01149"></a>01149             retval = dup2(fds[1], <a class="code" href="nerd_8h.html#acba6ef2e5aa80202ccb9560d240e0f62" title="Servers must write the local port number that they are using to this file descriptor in network byte ...">NERD_PIPE_FD</a>);
<a name="l01150"></a>01150             <span class="keywordflow">if</span> (retval == -1)
<a name="l01151"></a>01151             {
<a name="l01152"></a>01152                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error setting pipe file descriptor: %s&quot;</span>, std::strerror(errno));
<a name="l01153"></a>01153                 std::exit(EXIT_FAILURE);
<a name="l01154"></a>01154             }
<a name="l01155"></a>01155             
<a name="l01156"></a>01156             <span class="comment">// if we want to drop privileges, get the link owner before opening</span>
<a name="l01157"></a>01157             <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#ae54611cb80881c2a73d69e145df4bbd7" title="true to limit the privileges of server programs; false otherwise.">restrict_servers</a>)
<a name="l01158"></a>01158             {
<a name="l01159"></a>01159                 retval = lstat(server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), &amp;linkstat);
<a name="l01160"></a>01160                 <span class="keywordflow">if</span> (retval == -1)
<a name="l01161"></a>01161                 {
<a name="l01162"></a>01162                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error determing ownership of server %s: %s&quot;</span>, server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), std::strerror(errno));
<a name="l01163"></a>01163                     std::exit(EXIT_FAILURE);
<a name="l01164"></a>01164                 }
<a name="l01165"></a>01165             }
<a name="l01166"></a>01166             
<a name="l01167"></a>01167             <span class="comment">// open the server file</span>
<a name="l01168"></a>01168             server_fd = open(server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), O_RDONLY);
<a name="l01169"></a>01169             <span class="keywordflow">if</span> (server_fd == -1)
<a name="l01170"></a>01170             {
<a name="l01171"></a>01171                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error opening server %s: %s&quot;</span>, server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), std::strerror(errno));
<a name="l01172"></a>01172                 std::exit(EXIT_FAILURE);
<a name="l01173"></a>01173             }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175             <span class="comment">// close open files on execve</span>
<a name="l01176"></a>01176             <a class="code" href="namespaceLibWheel.html#a941108ec3b987f98a677f78dc36eace0" title="Set the &quot;close-on-exec&quot; attribute on open file descriptors greater than maxfd.">LibWheel::close_files_on_exec</a>(<a class="code" href="nerd_8h.html#acba6ef2e5aa80202ccb9560d240e0f62" title="Servers must write the local port number that they are using to this file descriptor in network byte ...">NERD_PIPE_FD</a>);
<a name="l01177"></a>01177             
<a name="l01178"></a>01178             <span class="comment">// drop privileges</span>
<a name="l01179"></a>01179             <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#ae54611cb80881c2a73d69e145df4bbd7" title="true to limit the privileges of server programs; false otherwise.">restrict_servers</a>)
<a name="l01180"></a>01180             {
<a name="l01181"></a>01181                 <span class="comment">// first, make sure that the link and target owners are the same</span>
<a name="l01182"></a>01182                 retval = fstat(server_fd, &amp;filestat);
<a name="l01183"></a>01183                 <span class="keywordflow">if</span> (retval == -1)
<a name="l01184"></a>01184                 {
<a name="l01185"></a>01185                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error determing ownership of server %s: %s&quot;</span>, server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), std::strerror(errno));
<a name="l01186"></a>01186                     std::exit(EXIT_FAILURE);
<a name="l01187"></a>01187                 }
<a name="l01188"></a>01188                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((filestat.st_uid != linkstat.st_uid) || (filestat.st_gid != linkstat.st_gid))
<a name="l01189"></a>01189                 {
<a name="l01190"></a>01190                     <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot launch server %s: Permission denied (The symbolic link %s and its target have different owners.)&quot;</span>, server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str());
<a name="l01191"></a>01191                     std::exit(EXIT_FAILURE);
<a name="l01192"></a>01192                 }
<a name="l01193"></a>01193             
<a name="l01194"></a>01194                 <a class="code" href="drop__priv_8c.html#a8774b10985df500e9dcbf5378e5abf6e" title="Drops privileges by setting the effective and real UID and GID to specified values.">LibWheel::drop_priv</a>(linkstat.st_uid, linkstat.st_gid);
<a name="l01195"></a>01195             }
<a name="l01196"></a>01196             
<a name="l01197"></a>01197             <span class="comment">// launch the server</span>
<a name="l01198"></a>01198             server_args[0] = strdup(server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str());
<a name="l01199"></a>01199             server_args[1] = strdup(server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a741796c62f55fc2d3b7ac5807d4bfdf8" title="The IP address to be emulated by a server program, as a string.">serverAddr</a>.c_str());
<a name="l01200"></a>01200             server_args[2] = strdup(server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a8eeda51ef462eeabb3d66b130fe70e56" title="The port number to be emulated by a server program, as a string.">serverPort</a>.c_str());
<a name="l01201"></a>01201             server_args[3] = strdup(server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a1272b0f4ca611ecc8c2b2b76c75c5f91" title="The DNS TXT record for serverAddr.">serverDnsRecord</a>.c_str());
<a name="l01202"></a>01202             server_args[4] = NULL;
<a name="l01203"></a>01203             server_env[0] = NULL;
<a name="l01204"></a>01204 <span class="preprocessor">#ifdef BROKEN_FEXECVE</span>
<a name="l01205"></a>01205 <span class="preprocessor"></span>            <span class="comment">/* WARNING: TOCTOU race condition here.  The way to solve it is to</span>
<a name="l01206"></a>01206 <span class="comment">               use fexecve().  However, Linux emulates fexecve with a library call</span>
<a name="l01207"></a>01207 <span class="comment">               that looks up the file for the given fd in /proc/self/fd, but </span>
<a name="l01208"></a>01208 <span class="comment">               after dropping privileges, we don&#39;t have access to /proc/self/fd</span>
<a name="l01209"></a>01209 <span class="comment">               anymore.  Kernels after 2.6.22-rc1 include a patch that allows</span>
<a name="l01210"></a>01210 <span class="comment">               processes that have called setuid() to access /proc/self/fd, so </span>
<a name="l01211"></a>01211 <span class="comment">               fexecve() should work on them. */</span>
<a name="l01212"></a>01212             retval = execve(server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), server_args, server_env);
<a name="l01213"></a>01213 <span class="preprocessor">#else</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span>            retval = fexecve(server_fd, server_args, server_env);
<a name="l01215"></a>01215 <span class="preprocessor">#endif</span>
<a name="l01216"></a>01216 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (retval == -1)
<a name="l01217"></a>01217             {
<a name="l01218"></a>01218                 <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot launch server %s: %s&quot;</span>, server.<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html#a9bacaaa47cedda53feb069fbc1be8b8c" title="The name of a server program.">serverProgram</a>.c_str(), std::strerror(errno));
<a name="l01219"></a>01219                 std::exit(EXIT_FAILURE);
<a name="l01220"></a>01220             }
<a name="l01221"></a>01221         }
<a name="l01222"></a>01222     }
<a name="l01223"></a>01223     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownServerException.html" title="Exception thrown by findServer() when no server program can be found to handle a new connection...">UnknownServerException</a>&amp; e)
<a name="l01224"></a>01224     {
<a name="l01225"></a>01225         <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403" title="true to log extra messages; false otherwise">verbose</a>)
<a name="l01226"></a>01226             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;No appropriate server found to handle connection to %s:%hu/TCP&quot;</span>, <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(pkt-&gt;<a class="code" href="classIPQ_1_1IpqIpPacket.html#a056bedcbf7998452d147f2d2ef68b611" title="Retrieve the destination IP address of a packet.">getIpDest</a>()).c_str(), pkt-&gt;<a class="code" href="classIPQ_1_1IpqTcpPacket.html#ad2fc945448bbfc68a682bf6cd354f35f" title="Retrieve the TCP destination port of a packet.">getTcpDest</a>());
<a name="l01227"></a>01227         <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(pkt, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l01228"></a>01228     }
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 
<a name="l01237"></a>01237 <span class="keywordtype">void</span> 
<a name="l01238"></a><a class="code" href="classNERD_1_1ConnectionServer.html#ae713c47afe1f248809de764dfda4f1b2">01238</a> <a class="code" href="classNERD_1_1ConnectionServer.html#af4ba681fed213914c83661a1dfd8df6d" title="Creates a TCP connection.">ConnectionServer::createConnection</a>(<a class="code" href="classIPQ_1_1IpqUdpPacket.html" title="An complete IPv4/UDP packet that was received via IpqSocket.">IPQ::IpqUdpPacket</a>* pkt)
<a name="l01239"></a>01239 {
<a name="l01240"></a>01240     <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403" title="true to log extra messages; false otherwise">verbose</a>)
<a name="l01241"></a>01241         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;UDP connection forwarding is not supported at this time&quot;</span>);
<a name="l01242"></a>01242     <a class="code" href="classNERD_1_1ConnectionServer.html#ad9575a11fd2db34b92ab1627c2d1d5b0" title="A handle to libipq.">sock</a>.<a class="code" href="classIPQ_1_1IpqSocket.html#a53e0f4e45363cbcd919a2d96ee7cf0a8" title="Sets the verdict on a packet.">sendResponse</a>(pkt, <a class="code" href="classIPQ_1_1IpqSocket.html#a2aaaf01ab3bdb3a4a7f90dd142fd93cca2f14f71dc344cea511b9a9e7a553ed99" title="Accept the packet and continue iptables traversal.">IPQ::IpqSocket::ACCEPT</a>);
<a name="l01243"></a>01243 }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 
<a name="l01277"></a>01277 <span class="keywordtype">void</span>
<a name="l01278"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a9d75b0d048d374095c4d7c96e4add7f8">01278</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a9d75b0d048d374095c4d7c96e4add7f8" title="Attempts to find a server program to run in response to a connection request.">ConnectionServer::findServer</a>(<a class="code" href="structNERD_1_1ConnectionServer_1_1ServerRecord.html" title="Information about a server program to be started.">ServerRecord</a>&amp; rec, in_addr_t addr) <span class="keyword">const</span> <a class="code" href="libwheel_8h.html#a27264efd631c4f584ddcb2f5888ae6ed" title="Allows a program to check exceptions in debug builds while skipping the checks in release builds...">THROW</a>((<a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownServerException.html" title="Exception thrown by findServer() when no server program can be found to handle a new connection...">UnknownServerException</a>))
<a name="l01279"></a>01279 {
<a name="l01280"></a>01280     std::string name;
<a name="l01281"></a>01281 
<a name="l01282"></a>01282     <span class="comment">// first, try SERVER_DIR/&lt;addr&gt;:&lt;port&gt;</span>
<a name="l01283"></a>01283     name = <a class="code" href="classNERD_1_1ConnectionServer.html#a5e476e6dd3a15d073b4a3f75569dc240" title="The directory in which to search for server programs.">serverRoot</a> + <span class="charliteral">&#39;/&#39;</span> + rec.serverAddr + <span class="charliteral">&#39;:&#39;</span> + rec.serverPort;
<a name="l01284"></a>01284     <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a31818d0fbe0366a7b902095445405406" title="Determines if a file is executable.">isExecutable</a>(name))
<a name="l01285"></a>01285     {
<a name="l01286"></a>01286         rec.serverProgram = name;
<a name="l01287"></a>01287         rec.serverDnsRecord = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01288"></a>01288         <span class="keywordflow">return</span>;
<a name="l01289"></a>01289     }
<a name="l01290"></a>01290     
<a name="l01291"></a>01291     <span class="comment">// next, try SERVER_DIR/&lt;addr&gt;</span>
<a name="l01292"></a>01292     name = <a class="code" href="classNERD_1_1ConnectionServer.html#a5e476e6dd3a15d073b4a3f75569dc240" title="The directory in which to search for server programs.">serverRoot</a> + <span class="charliteral">&#39;/&#39;</span> + rec.serverAddr;
<a name="l01293"></a>01293     <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a31818d0fbe0366a7b902095445405406" title="Determines if a file is executable.">isExecutable</a>(name))
<a name="l01294"></a>01294     {
<a name="l01295"></a>01295         rec.serverProgram = name;
<a name="l01296"></a>01296         rec.serverDnsRecord = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01297"></a>01297         <span class="keywordflow">return</span>;
<a name="l01298"></a>01298     }
<a name="l01299"></a>01299     
<a name="l01300"></a>01300     <span class="comment">// finally, try DNS lookup</span>
<a name="l01301"></a>01301     <span class="keywordflow">try</span>
<a name="l01302"></a>01302     {
<a name="l01303"></a>01303         std::vector&lt;std::string&gt; dnstxt = <a class="code" href="namespaceLibWheel.html#ab30bbb7dd8080f582e9b497903565bab" title="Retrieve a DNS TXT record for an IP address.">LibWheel::getDnsTxt</a>(addr);
<a name="l01304"></a>01304         <span class="keywordflow">if</span> (dnstxt.size() &gt; 1)
<a name="l01305"></a>01305             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6ac733d04ddc45cea012eb285d47ef4d10" title="Warning condition.">LibWheel::logmsg_warning</a>, <span class="stringliteral">&quot;Warning: more than one DNS TXT record found for %s&quot;</span>, <a class="code" href="namespaceLibWheel.html#a922fd717077d5a27328412f69c8d9d8c" title="Converts an IPv4 address to a string in dotted-decimal format.">LibWheel::ipv4_to_string</a>(addr).c_str());
<a name="l01306"></a>01306         <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a36f12900d6c2461984a1e093bfc42403" title="true to log extra messages; false otherwise">verbose</a>)
<a name="l01307"></a>01307             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a44407e7d68dfe524a440c50a8f8c54b0" title="Informational message.">LibWheel::logmsg_info</a>, <span class="stringliteral">&quot;DNS TXT record found: %s&quot;</span>, dnstxt[0].c_str());
<a name="l01308"></a>01308 
<a name="l01309"></a>01309         <span class="comment">// parse the record and look for a server program name</span>
<a name="l01310"></a>01310         <a class="code" href="classNERD_1_1DnsServerRecord.html" title="Holds a DNS TXT server record.">DnsServerRecord</a> dnsrec(dnstxt[0]);
<a name="l01311"></a>01311         <a class="code" href="classNERD_1_1DnsServerRecord.html" title="Holds a DNS TXT server record.">DnsServerRecord</a>::const_iterator entry = dnsrec.<a class="code" href="classNERD_1_1DnsServerRecord.html#a870088e0f9b25fa8638518dc61efbd6a" title="Retrieve the value for a given key in a DNS server record.">getValue</a>(std::string(<span class="stringliteral">&quot;P&quot;</span>)+rec.serverPort);
<a name="l01312"></a>01312         <span class="keywordflow">if</span> (entry != dnsrec.<a class="code" href="classNERD_1_1DnsServerRecord.html#ac66bbdc0eb78b35c61e95a5736390e64" title="Retrieves a constant bidirectional iterator to just past the last entry in the record.">end</a>())
<a name="l01313"></a>01313         {
<a name="l01314"></a>01314             name = <a class="code" href="classNERD_1_1ConnectionServer.html#a5e476e6dd3a15d073b4a3f75569dc240" title="The directory in which to search for server programs.">serverRoot</a> + <span class="charliteral">&#39;/&#39;</span> + entry-&gt;second;
<a name="l01315"></a>01315             <span class="keywordflow">if</span> (<a class="code" href="classNERD_1_1ConnectionServer.html#a31818d0fbe0366a7b902095445405406" title="Determines if a file is executable.">isExecutable</a>(name))
<a name="l01316"></a>01316             {
<a name="l01317"></a>01317                 rec.serverProgram = name;
<a name="l01318"></a>01318                 rec.serverDnsRecord = dnstxt[0];
<a name="l01319"></a>01319                 <span class="keywordflow">return</span>;
<a name="l01320"></a>01320             }
<a name="l01321"></a>01321         }
<a name="l01322"></a>01322     }
<a name="l01323"></a>01323     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classLibWheel_1_1DNSFailure.html" title="Exception thrown when a DNS lookup fails.">LibWheel::DNSFailure</a>&amp; e)
<a name="l01324"></a>01324     {}
<a name="l01325"></a>01325     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classLibWheel_1_1DNSError.html" title="Exception thrown when an error is encountered parsing a DNS record.">LibWheel::DNSError</a>&amp; e)
<a name="l01326"></a>01326     {
<a name="l01327"></a>01327         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;DNS error: %s&quot;</span>, e.what());
<a name="l01328"></a>01328     }
<a name="l01329"></a>01329     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classLibWheel_1_1ParseError.html" title="Exception throws when a parsing error occurs.">LibWheel::ParseError</a>&amp; e)
<a name="l01330"></a>01330     {
<a name="l01331"></a>01331         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Error parsing DNS TXT record: %s&quot;</span>, e.what());
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333 
<a name="l01334"></a>01334     <span class="keywordflow">throw</span> <a class="code" href="classNERD_1_1ConnectionServer_1_1UnknownServerException.html" title="Exception thrown by findServer() when no server program can be found to handle a new connection...">UnknownServerException</a>(<span class="stringliteral">&quot;No server found&quot;</span>);
<a name="l01335"></a>01335 }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337 
<a name="l01346"></a>01346 <span class="keywordtype">bool</span>
<a name="l01347"></a><a class="code" href="classNERD_1_1ConnectionServer.html#a31818d0fbe0366a7b902095445405406">01347</a> <a class="code" href="classNERD_1_1ConnectionServer.html#a31818d0fbe0366a7b902095445405406" title="Determines if a file is executable.">ConnectionServer::isExecutable</a>(<span class="keyword">const</span> std::string&amp; file)<span class="keyword"> const</span>
<a name="l01348"></a>01348 <span class="keyword"></span>{
<a name="l01349"></a>01349     <span class="keywordtype">int</span> retval;
<a name="l01350"></a>01350     <span class="keyword">struct </span>stat statbuf;
<a name="l01351"></a>01351     
<a name="l01352"></a>01352     <span class="comment">// check that the file exists and is is a regular file</span>
<a name="l01353"></a>01353     retval = ::stat(file.c_str(), &amp;statbuf);
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (retval == -1)
<a name="l01355"></a>01355     {
<a name="l01356"></a>01356         <span class="keywordflow">if</span> (errno != ENOENT)
<a name="l01357"></a>01357             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot execute server %s: %s&quot;</span>, file.c_str(), std::strerror(errno));
<a name="l01358"></a>01358         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360     
<a name="l01361"></a>01361     <span class="comment">// check at the file is executable by the current user</span>
<a name="l01362"></a>01362     retval = ::access(file.c_str(), F_OK|X_OK);
<a name="l01363"></a>01363     <span class="keywordflow">if</span> (retval == -1)
<a name="l01364"></a>01364     {
<a name="l01365"></a>01365         <span class="keywordflow">if</span> (errno != ENOENT)
<a name="l01366"></a>01366             <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a759559a69b6b4023ed122cf92d2ebcee" title="Error condtion.">LibWheel::logmsg_err</a>, <span class="stringliteral">&quot;Cannot execute server %s: %s&quot;</span>, file.c_str(), std::strerror(errno));
<a name="l01367"></a>01367         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01368"></a>01368     }
<a name="l01369"></a>01369     
<a name="l01370"></a>01370     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01371"></a>01371 }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373 
<a name="l01377"></a><a class="code" href="classNERD_1_1StatPrinter.html#a9e15d664037ee9b034a20e4a2c758e37">01377</a> <a class="code" href="classNERD_1_1StatPrinter.html#a9e15d664037ee9b034a20e4a2c758e37" title="Initialize a StatPrinter.">StatPrinter::StatPrinter</a>(<span class="keyword">const</span> <a class="code" href="classNERD_1_1ConnectionServer.html" title="The main class for the Network Rerouter Daemon (nerd).">ConnectionServer</a>&amp; cs)
<a name="l01378"></a>01378 : connectionServer(cs)
<a name="l01379"></a>01379 {}
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 
<a name="l01386"></a>01386 <span class="keywordtype">void</span>
<a name="l01387"></a><a class="code" href="classNERD_1_1StatPrinter.html#a276b7e4358a2cd8ec5a3972f86452d2c">01387</a> <a class="code" href="classNERD_1_1StatPrinter.html#a276b7e4358a2cd8ec5a3972f86452d2c" title="Print the current statistics for a ConnectionServer.">StatPrinter::operator()</a>()<span class="keyword"> const</span>
<a name="l01388"></a>01388 <span class="keyword"></span>{
<a name="l01389"></a>01389     <a class="code" href="classNERD_1_1StatPrinter.html#a6040df27f017b5ce2ac0ed1d9f68d50b" title="A reference to a server object whose statistica are to be printed.">connectionServer</a>.<a class="code" href="classNERD_1_1ConnectionServer.html#a52574c2792a324c56435234da19cc183" title="Print current server status to LibWheel::logmsg.">printStats</a>();
<a name="l01390"></a>01390 }
<a name="l01391"></a>01391 
<a name="l01392"></a>01392 
<a name="l01396"></a>01396 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l01397"></a><a class="code" href="namespaceNERD.html#a71e1a6782f9ca0dad5c6215030cb69dd">01397</a> <a class="code" href="namespaceNERD.html#a71e1a6782f9ca0dad5c6215030cb69dd" title="Print version info to stderr.">print_version</a>()
<a name="l01398"></a>01398 {
<a name="l01399"></a>01399     std::cerr &lt;&lt; <span class="stringliteral">&quot;Network Rerouter Daemon v&quot;</span> &lt;&lt;  <a class="code" href="nerd_8h.html#aca443d46068e6798392b31ed401d0772" title="Version of NERD described by this file.">NERD_VERSION</a>
<a name="l01400"></a>01400 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01401"></a>01401 <span class="preprocessor"></span>              &lt;&lt; <span class="stringliteral">&quot; (debug build)&quot;</span>
<a name="l01402"></a>01402 <span class="preprocessor">#endif</span>
<a name="l01403"></a>01403 <span class="preprocessor"></span>              &lt;&lt; <span class="stringliteral">&quot;\nCopyright (c) Rennie deGraaf, 2007.  All rights reserved.&quot;</span>
<a name="l01404"></a>01404               &lt;&lt; std::endl;
<a name="l01405"></a>01405 }
<a name="l01406"></a>01406 
<a name="l01407"></a>01407 
<a name="l01411"></a>01411 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01412"></a><a class="code" href="namespaceNERD.html#a55373ab13cf2b623be6d20f03be57f93">01412</a> <a class="code" href="namespaceNERD.html#a55373ab13cf2b623be6d20f03be57f93" title="Print a help message to stderr.">print_help</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* progname)
<a name="l01413"></a>01413 {
<a name="l01414"></a>01414     std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; progname  &lt;&lt; <span class="stringliteral">&quot;[-D] [-V] [-h] [-v]\n&quot;</span>
<a name="l01415"></a>01415               &lt;&lt; <span class="stringliteral">&quot;where -D - run the program as a daemon\n&quot;</span>
<a name="l01416"></a>01416               &lt;&lt; <span class="stringliteral">&quot;      -V - enable verbose logging\n&quot;</span>
<a name="l01417"></a>01417               &lt;&lt; <span class="stringliteral">&quot;      -h - print this message\n&quot;</span>
<a name="l01418"></a>01418               &lt;&lt; <span class="stringliteral">&quot;      -v - print version information\n&quot;</span>
<a name="l01419"></a>01419               &lt;&lt; std::endl;
<a name="l01420"></a>01420 }
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 
<a name="l01432"></a>01432 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l01433"></a><a class="code" href="namespaceNERD.html#aa16f179fc762db5db0912611f1a82d57">01433</a> <a class="code" href="namespaceNERD.html#aa16f179fc762db5db0912611f1a82d57" title="Parse command-line arguments.">parse_args</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv, <span class="keywordtype">bool</span>&amp; daemon, <span class="keywordtype">bool</span>&amp; verbose)
<a name="l01434"></a>01434 {
<a name="l01435"></a>01435     <span class="keywordtype">char</span>* short_options = <span class="stringliteral">&quot;DhvV&quot;</span>;
<a name="l01436"></a>01436     <span class="keyword">static</span> <span class="keyword">struct </span>option long_options[] = {
<a name="l01437"></a>01437         {<span class="stringliteral">&quot;daemon&quot;</span>, 0, 0, <span class="charliteral">&#39;D&#39;</span>},
<a name="l01438"></a>01438         {<span class="stringliteral">&quot;verbose&quot;</span>, 0, 0, <span class="charliteral">&#39;V&#39;</span>},
<a name="l01439"></a>01439         {<span class="stringliteral">&quot;help&quot;</span>, 0, 0, <span class="charliteral">&#39;h&#39;</span>},
<a name="l01440"></a>01440         {<span class="stringliteral">&quot;version&quot;</span>, 0, 0, <span class="charliteral">&#39;v&#39;</span>},
<a name="l01441"></a>01441         {0, 0, 0, 0}
<a name="l01442"></a>01442     };
<a name="l01443"></a>01443     <span class="keywordtype">int</span> option_index = 0;
<a name="l01444"></a>01444     <span class="keywordtype">int</span> c;
<a name="l01445"></a>01445     
<a name="l01446"></a>01446     <span class="keywordflow">while</span> ((c = getopt_long(argc, argv, short_options, long_options, &amp;option_index)) != -1)
<a name="l01447"></a>01447     {
<a name="l01448"></a>01448         <span class="keywordflow">switch</span> (c)
<a name="l01449"></a>01449         {
<a name="l01450"></a>01450             <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span>:
<a name="l01451"></a>01451                 daemon = <span class="keyword">true</span>;
<a name="l01452"></a>01452                 <span class="keywordflow">break</span>;
<a name="l01453"></a>01453             <span class="keywordflow">case</span> <span class="charliteral">&#39;V&#39;</span>:
<a name="l01454"></a>01454                 verbose = <span class="keyword">true</span>;
<a name="l01455"></a>01455                 <span class="keywordflow">break</span>;
<a name="l01456"></a>01456             <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:
<a name="l01457"></a>01457                 <a class="code" href="namespaceNERD.html#a71e1a6782f9ca0dad5c6215030cb69dd" title="Print version info to stderr.">print_version</a>();
<a name="l01458"></a>01458                 <a class="code" href="namespaceNERD.html#a55373ab13cf2b623be6d20f03be57f93" title="Print a help message to stderr.">print_help</a>(argv[0]);
<a name="l01459"></a>01459                 std::exit(EXIT_SUCCESS);
<a name="l01460"></a>01460             <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:
<a name="l01461"></a>01461                 <a class="code" href="namespaceNERD.html#a71e1a6782f9ca0dad5c6215030cb69dd" title="Print version info to stderr.">print_version</a>();
<a name="l01462"></a>01462                 std::exit(EXIT_SUCCESS);
<a name="l01463"></a>01463             <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:
<a name="l01464"></a>01464                 <span class="keywordflow">if</span> (isprint(optopt))
<a name="l01465"></a>01465                     std::cerr &lt;&lt; <span class="stringliteral">&quot;Unrecognized option -&quot;</span> &lt;&lt; <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span>(optopt) &lt;&lt; std::endl;
<a name="l01466"></a>01466                 <span class="keywordflow">else</span>
<a name="l01467"></a>01467                     std::cerr &lt;&lt; <span class="stringliteral">&quot;Unrecognized option character 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; optopt &lt;&lt; std::dec &lt;&lt; std::endl;
<a name="l01468"></a>01468                 std::exit(EXIT_FAILURE);
<a name="l01469"></a>01469             <span class="keywordflow">case</span> <span class="charliteral">&#39;0&#39;</span>:
<a name="l01470"></a>01470             <span class="keywordflow">default</span>:
<a name="l01471"></a>01471                 std::cerr &lt;&lt; <span class="stringliteral">&quot;getopt() returned an unexpected value&quot;</span> &lt;&lt; std::endl;
<a name="l01472"></a>01472                 std::exit(EXIT_FAILURE);
<a name="l01473"></a>01473         }
<a name="l01474"></a>01474     }
<a name="l01475"></a>01475     
<a name="l01476"></a>01476     <span class="keywordflow">if</span> (optind &lt; argc)
<a name="l01477"></a>01477     {
<a name="l01478"></a>01478         std::cerr &lt;&lt; <span class="stringliteral">&quot;Unrecognized garbage on the command line: &quot;</span>;
<a name="l01479"></a>01479         <span class="keywordflow">while</span> (optind &lt; argc)
<a name="l01480"></a>01480             std::cerr &lt;&lt; argv[optind++] &lt;&lt; <span class="charliteral">&#39; &#39;</span>;
<a name="l01481"></a>01481         std::cerr &lt;&lt; std::endl;
<a name="l01482"></a>01482         std::exit(EXIT_FAILURE);
<a name="l01483"></a>01483     }
<a name="l01484"></a>01484 
<a name="l01485"></a>01485 }
<a name="l01486"></a>01486 
<a name="l01487"></a>01487 } <span class="comment">// namespace NERD</span>
<a name="l01488"></a>01488 
<a name="l01489"></a>01489 
<a name="l01513"></a>01513 <span class="keywordtype">int</span> 
<a name="l01514"></a><a class="code" href="nerd_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">01514</a> <a class="code" href="echod_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="An echo server for nerd.">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
<a name="l01515"></a>01515 {
<a name="l01516"></a>01516     <span class="keywordtype">bool</span> make_daemon = <span class="keyword">false</span>;
<a name="l01517"></a>01517     <span class="keywordtype">bool</span> verbose = <span class="keyword">false</span>;
<a name="l01518"></a>01518     <span class="keywordtype">int</span> ret = EXIT_SUCCESS;
<a name="l01519"></a>01519     <span class="comment">/*uid_t ruid;</span>
<a name="l01520"></a>01520 <span class="comment">    gid_t rgid;*/</span>
<a name="l01521"></a>01521     
<a name="l01522"></a>01522     <span class="comment">// initialize the logmsg facility (spc_sanitize_* needs it)</span>
<a name="l01523"></a>01523     LibWheel<a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">::logmsg</a>.open(<a class="code" href="logmsg_8h.html#a79de13cee8c9b70b7851d97b86d4bbe5a8fc9520816e928c66eac877147cce18d" title="Write messages to stderr (default).">LibWheel::logmsg_stderr</a>, 0, argv[0]);
<a name="l01524"></a>01524     
<a name="l01525"></a>01525     <span class="comment">// sanitize the system</span>
<a name="l01526"></a>01526     <a class="code" href="spc__sanitize_8c.html#a18dab71b05a119176ff814914a4c590a" title="Sanitizes the system environment.">LibWheel::spc_sanitize_environment</a>(0, NULL);
<a name="l01527"></a>01527     <a class="code" href="spc__sanitize_8c.html#a48b9352fb99aad561f6d6edd492084b4" title="Closes all file descriptors above a limit, and ensures that stdin, stdout, and stderr are open...">LibWheel::spc_sanitize_files</a>(2);
<a name="l01528"></a>01528     
<a name="l01529"></a>01529     <span class="comment">// parse command-line arguments</span>
<a name="l01530"></a>01530     <a class="code" href="namespaceNERD.html#aa16f179fc762db5db0912611f1a82d57" title="Parse command-line arguments.">NERD::parse_args</a>(argc, argv, make_daemon, verbose);
<a name="l01531"></a>01531 
<a name="l01532"></a>01532 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01533"></a>01533 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((verbose == <span class="keyword">false</span>) || (make_daemon = <span class="keyword">true</span>))
<a name="l01534"></a>01534         std::cerr &lt;&lt; <span class="stringliteral">&quot;This is a debug build; enabling verbose logging and disabling daemon mode&quot;</span> &lt;&lt; std::endl;
<a name="l01535"></a>01535     verbose = <span class="keyword">true</span>;
<a name="l01536"></a>01536     make_daemon = <span class="keyword">false</span>;
<a name="l01537"></a>01537 <span class="preprocessor">#endif</span>
<a name="l01538"></a>01538 <span class="preprocessor"></span>    
<a name="l01539"></a>01539     <span class="comment">// make sure that we&#39;re running as root</span>
<a name="l01540"></a>01540     <span class="keywordflow">if</span> (geteuid() != 0)
<a name="l01541"></a>01541     {
<a name="l01542"></a>01542         std::cerr &lt;&lt; <span class="stringliteral">&quot;This program requires superuser privileges&quot;</span> &lt;&lt; std::endl;
<a name="l01543"></a>01543         LibWheel<a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">::logmsg</a>.close();
<a name="l01544"></a>01544         std::exit(EXIT_FAILURE);
<a name="l01545"></a>01545     }
<a name="l01546"></a>01546     
<a name="l01547"></a>01547     <span class="comment">// get the uid and gid for the restricted user and group</span>
<a name="l01548"></a>01548     <span class="comment">/*ruid = LibWheel::get_user_uid(NERD_RESTRICTED_USER);</span>
<a name="l01549"></a>01549 <span class="comment">    if (ruid == (uid_t)-1)</span>
<a name="l01550"></a>01550 <span class="comment">    {</span>
<a name="l01551"></a>01551 <span class="comment">        std::cerr &lt;&lt; &quot;Error: user \&quot;&quot;NERD_RESTRICTED_USER&quot;\&quot; does not exist&quot; &lt;&lt; std::endl;</span>
<a name="l01552"></a>01552 <span class="comment">        LibWheel::logmsg.close();</span>
<a name="l01553"></a>01553 <span class="comment">        return EXIT_FAILURE;</span>
<a name="l01554"></a>01554 <span class="comment">    }</span>
<a name="l01555"></a>01555 <span class="comment">    rgid = LibWheel::get_group_gid(NERD_RESTRICTED_GROUP);</span>
<a name="l01556"></a>01556 <span class="comment">    if (rgid == (gid_t)-1)</span>
<a name="l01557"></a>01557 <span class="comment">    {</span>
<a name="l01558"></a>01558 <span class="comment">        std::cerr &lt;&lt; &quot;Error: group \&quot;&quot;NERD_RESTRICTED_GROUP&quot;\&quot; does not exist&quot; &lt;&lt; std::endl;</span>
<a name="l01559"></a>01559 <span class="comment">        LibWheel::logmsg.close();</span>
<a name="l01560"></a>01560 <span class="comment">        return EXIT_FAILURE;</span>
<a name="l01561"></a>01561 <span class="comment">    }</span>
<a name="l01562"></a>01562 <span class="comment">    if ((ruid == 0) || (rgid == 0))</span>
<a name="l01563"></a>01563 <span class="comment">    {</span>
<a name="l01564"></a>01564 <span class="comment">        std::cerr &lt;&lt; &quot;WARNING: Running servers with root privileges!&quot; &lt;&lt; std::endl;</span>
<a name="l01565"></a>01565 <span class="comment">    }*/</span>
<a name="l01566"></a>01566 
<a name="l01567"></a>01567     <span class="comment">// set up exit signal handlers</span>
<a name="l01568"></a>01568     LibWheel::Thrower&lt;LibWheel::Interrupt&gt; sigint_handler;
<a name="l01569"></a>01569     <a class="code" href="classLibWheel_1_1SignalQueue.html#ac0145e9276c339fccebe3c0b70cec914" title="Set the action to perform when a signal is received.">LibWheel::SignalQueue::setHandler</a>(SIGINT, <a class="code" href="classLibWheel_1_1SignalQueue.html#a5a366bd8de3564c5e3001233464d20e3a4ee98693cfe0961ea7dcfac5f2053174" title="Call all registered signal handlers when a signal is received.">LibWheel::SignalQueue::HANDLE</a>);
<a name="l01570"></a>01570     <a class="code" href="classLibWheel_1_1SignalQueue.html#ada6b998cee9ced93ac7e046199187fa6" title="Add a handler function for a signal.">LibWheel::SignalQueue::addHandler</a>(SIGINT, boost::ref(sigint_handler));
<a name="l01571"></a>01571     
<a name="l01572"></a>01572     <span class="keywordflow">try</span>
<a name="l01573"></a>01573     {
<a name="l01574"></a>01574         NERD::ConnectionServer server(<a class="code" href="nerd_8h.html#a7c7332d88dae4ce42af07cb9b114f13b" title="Servers (or symbolic links to them) must be stored in this directory.">NERD_SERVER_ROOT</a>, verbose, <span class="keyword">true</span>);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576         <span class="comment">// drop privileges</span>
<a name="l01577"></a>01577         <span class="comment">/* ip_queue requires root privileges even after opening.  We&#39;ll drop</span>
<a name="l01578"></a>01578 <span class="comment">           privileges before executing servers instead */</span>
<a name="l01579"></a>01579         <span class="comment">//drop_priv(ruid, rgid);</span>
<a name="l01580"></a>01580 
<a name="l01581"></a>01581         <span class="comment">// we&#39;ve finished initializing; time to summon Beelzebub</span>
<a name="l01582"></a>01582         <span class="keywordflow">if</span> (make_daemon)
<a name="l01583"></a>01583         {
<a name="l01584"></a>01584             <span class="comment">// Ia Ia Cthulhu Fhtagn!</span>
<a name="l01585"></a>01585             daemon(0, 0);
<a name="l01586"></a>01586 
<a name="l01587"></a>01587             <span class="comment">// stderr is closed; switch to syslog</span>
<a name="l01588"></a>01588             LibWheel<a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">::logmsg</a>.open(<a class="code" href="logmsg_8h.html#a79de13cee8c9b70b7851d97b86d4bbe5aa718e2f4ad9d3dcabfff1835271fe59e" title="Send message to syslog.">LibWheel::logmsg_syslog</a>, 0, argv[0]);
<a name="l01589"></a>01589             
<a name="l01590"></a>01590             <span class="comment">// write our PID to /var/run/nerd.pid</span>
<a name="l01591"></a>01591             <a class="code" href="namespaceLibWheel.html#a47a8ef54f60bc8780ca2a1339e05429c" title="Write the current PID to a file.">LibWheel::write_pid</a>(<a class="code" href="nerd_8cpp.html#af5fe208f8640c8c789a4d5d5b8ad47f5" title="When in daemon mode, write the PID to this file.">PIDFILE</a>);
<a name="l01592"></a>01592         }
<a name="l01593"></a>01593         
<a name="l01594"></a>01594         <span class="comment">// register SIGUSR1 to print status</span>
<a name="l01595"></a>01595         NERD::StatPrinter statPrinter(server);
<a name="l01596"></a>01596         <a class="code" href="classLibWheel_1_1SignalQueue.html#ac0145e9276c339fccebe3c0b70cec914" title="Set the action to perform when a signal is received.">LibWheel::SignalQueue::setHandler</a>(SIGUSR1, <a class="code" href="classLibWheel_1_1SignalQueue.html#a5a366bd8de3564c5e3001233464d20e3a4ee98693cfe0961ea7dcfac5f2053174" title="Call all registered signal handlers when a signal is received.">LibWheel::SignalQueue::HANDLE</a>);
<a name="l01597"></a>01597         <a class="code" href="classLibWheel_1_1SignalQueue.html#ada6b998cee9ced93ac7e046199187fa6" title="Add a handler function for a signal.">LibWheel::SignalQueue::addHandler</a>(SIGUSR1, boost::ref(statPrinter));
<a name="l01598"></a>01598         
<a name="l01599"></a>01599         <span class="comment">// run the server</span>
<a name="l01600"></a>01600         server();
<a name="l01601"></a>01601     }
<a name="l01602"></a>01602     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classLibWheel_1_1IOException.html" title="Exception thrown when an I/O error occurs.">LibWheel::IOException</a>&amp; e)
<a name="l01603"></a>01603     {
<a name="l01604"></a>01604         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a34c890f87e77e66940cd4959dcccaac1" title="Critical error condition.">LibWheel::logmsg_crit</a>, <span class="stringliteral">&quot;I/O error: %s&quot;</span>, e.what());
<a name="l01605"></a>01605         ret = EXIT_FAILURE;
<a name="l01606"></a>01606     }
<a name="l01607"></a>01607     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classLibWheel_1_1SocketException.html" title="Exception thrown when a socket error occurs.">LibWheel::SocketException</a>&amp; e)
<a name="l01608"></a>01608     {
<a name="l01609"></a>01609         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a34c890f87e77e66940cd4959dcccaac1" title="Critical error condition.">LibWheel::logmsg_crit</a>, <span class="stringliteral">&quot;Socket error: %s&quot;</span>, e.what());
<a name="l01610"></a>01610         ret = EXIT_FAILURE;
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612     <span class="keywordflow">catch</span> (<span class="keyword">const</span> <a class="code" href="classIPQ_1_1IpqException.html" title="Base class for exceptions thrown by IPQ methods.">IPQ::IpqException</a>&amp; e)
<a name="l01613"></a>01613     {
<a name="l01614"></a>01614         <a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">LibWheel::logmsg</a>(<a class="code" href="logmsg_8h.html#a0b3d82d29e7bdec3d6961f3475f4f7f6a34c890f87e77e66940cd4959dcccaac1" title="Critical error condition.">LibWheel::logmsg_crit</a>, <span class="stringliteral">&quot;Error in ip_queue: %s&quot;</span>, e.what());
<a name="l01615"></a>01615         ret = EXIT_FAILURE;
<a name="l01616"></a>01616     }
<a name="l01617"></a>01617     
<a name="l01618"></a>01618     <span class="comment">// clean up</span>
<a name="l01619"></a>01619     <span class="keywordflow">if</span> (make_daemon)
<a name="l01620"></a>01620         (void)unlink(<a class="code" href="nerd_8cpp.html#af5fe208f8640c8c789a4d5d5b8ad47f5" title="When in daemon mode, write the PID to this file.">PIDFILE</a>);
<a name="l01621"></a>01621     LibWheel<a class="code" href="namespaceLibWheel.html#af4ca70f4f65b2948701218436516a679" title="Global logmsg object.">::logmsg</a>.close();
<a name="l01622"></a>01622     <span class="keywordflow">return</span> ret;
<a name="l01623"></a>01623 }
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed Nov 28 2012 13:00:07 for Network Rerouter Daemon (nerd) by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5
</small></address>

</body>
</html>
